

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Programmers Guide &mdash; AtomVM 0.6.7+git.c4628030 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=e925141f" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="canonical" href="https://doc.atomvm.org/release-0.6/programmers-guide.html" />
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=946ec285"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Network Programming Guide" href="network-programming-guide.html" />
    <link rel="prev" title="AtomVM Tooling" href="atomvm-tooling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/avm_logo_banner.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="welcome-to-atomvm.html">Welcome to AtomVM!</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started-guide.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="atomvm-tooling.html">AtomVM Tooling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Programmers Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#atomvm-features">AtomVM Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#atomvm-development">AtomVM Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#development-environment">Development Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#esp32-deployment-requirements">ESP32 Deployment Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stm32-deployment-requirements">STM32 Deployment Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#raspberry-pi-pico-deployment-requirements">Raspberry Pi Pico Deployment Requirements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#development-workflow">Development Workflow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#applications">Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#packbeam-files">Packbeam files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#packbeam-tool">packbeam tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-atomvm">Running <code class="docutils literal notranslate"><span class="pre">AtomVM</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#atomvm-program-syntax"><code class="docutils literal notranslate"><span class="pre">AtomVM</span></code> program syntax</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#core-apis">Core APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#standard-libraries">Standard Libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spawning-processes">Spawning Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#console-output">Console Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging">Logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-logger-manager">The <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-your-own-log-handler">Writing your own log handler</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#process-management">Process Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-term-format">External Term Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-apis">System APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-time">System Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#date-and-time">Date and Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous-apis">Miscellaneous APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stacktraces">StackTraces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-data-from-avm-files">Reading data from AVM files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-loading">Code Loading</a></li>
<li class="toctree-l3"><a class="reference internal" href="#math">Math</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cryptographic-operations">Cryptographic Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#esp32-specific-apis">ESP32-specific APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-level-apis">System-Level APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-volatile-storage">Non-volatile Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage">Storage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mounting-mmc-sd-card">Mounting MMC SD card</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mounting-spi-sd-card">Mounting SPI SD card</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mounting-internal-flash">Mounting internal flash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unmounting-storage">Unmounting Storage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#restart-and-deep-sleep">Restart and Deep Sleep</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rtc-memory">RTC Memory</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous-esp32-apis">Miscellaneous ESP32 APIs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#peripherals">Peripherals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gpio">GPIO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#digital-read">Digital Read</a></li>
<li class="toctree-l4"><a class="reference internal" href="#digital-write">Digital Write</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interrupt-handling">Interrupt Handling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#esp32-adc">ESP32 ADC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#esp32-adc-configuration-options">ESP32 ADC configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#esp32-adc-read-options">ESP32 ADC read options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#i2c">I2C</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spi">SPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uart">UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="#led-control">LED Control</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#protocols">Protocols</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#network-esp32-only">Network (ESP32 only)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sta-mode">STA mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ap-mode">AP mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sta-ap-mode">STA+AP mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sntp">SNTP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#udp">UDP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tcp">TCP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#server-side-tcp">Server-side TCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-side-tcp">Client-side TCP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#socket-programming">Socket Programming</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#server-side-tcp-socket-programming">Server-side TCP Socket Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#client-side-tcp-socket-programming">Client-side TCP Socket Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sending-and-receiving-data">Sending and Receiving Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-information-about-connected-sockets">Getting Information about Connected Sockets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#closing-and-shutting-down-sockets">Closing and Shutting down Sockets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-socket-options">Setting Socket Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#udp-socket-programming">UDP Socket Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous-networking-apis">Miscellaneous Networking APIs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#where-to-go-from-here">Where to go from here</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="network-programming-guide.html">Network Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-instructions.html">Build Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="atomvm-internals.html">AtomVM Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory-management.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="packbeam-format.html">Packbeam Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference-documentation.html">API Reference Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AtomVM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Programmers Guide</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <!--
 Copyright 2021-2022 Fred Dushin <fred@dushin.net>

 SPDX-License-Identifier: Apache-2.0 OR LGPL-2.1-or-later
-->
<section id="programmers-guide">
<h1>Programmers Guide<a class="headerlink" href="#programmers-guide" title="Link to this heading"></a></h1>
<p>This guide is intended for programmers who develop applications targeted for AtomVM.</p>
<p>As an implementation of the Erlang virtual machine, AtomVM is designed to execute unmodified byte-code instructions compiled into BEAM files, either by the Erlang or Elixir compilers.  This allow developers to write programs in their BEAM programming language of choice, and to use the common Erlang community tool-chains specific to their language platform, and to then deploy those applications onto the various devices that AtomVM supports.</p>
<p>This document describes the development workflow when writing AtomVM applications, as well as a high-level overview of the various APIs that are supported by AtomVM.  With an understanding of this guide, you should be able to design, implement, and deploy applications onto a device running the AtomVM virtual machine.</p>
<section id="atomvm-features">
<h2>AtomVM Features<a class="headerlink" href="#atomvm-features" title="Link to this heading"></a></h2>
<p>Currently, AtomVM implements a strict subset of the BEAM instruction set.</p>
<p>A high level overview of the supported language features include:</p>
<ul class="simple">
<li><p>All the major Erlang types, including</p>
<ul>
<li><p>integers (with size limits)</p></li>
<li><p>floats</p></li>
<li><p>tuples</p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/lists.html"><span class="std std-doc">lists</span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/binary.html"><span class="std std-doc">binaries</span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/maps.html"><span class="std std-doc">maps</span></a></p></li>
</ul>
</li>
<li><p>support for many Erlang BIFs and guard expressions to support the above types</p></li>
<li><p>pattern matching (case statements, function clause heads, etc)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">catch</span> <span class="pre">...</span> <span class="pre">finally</span></code> constructs</p></li>
<li><p>anonymous functions</p></li>
<li><p>process <code class="docutils literal notranslate"><span class="pre">spawn</span></code> and <code class="docutils literal notranslate"><span class="pre">spawn_link</span></code></p></li>
<li><p>send (<code class="docutils literal notranslate"><span class="pre">!</span></code>) and <code class="docutils literal notranslate"><span class="pre">receive</span></code> messages</p></li>
<li><p>bit syntax (with some restrictions)</p></li>
<li><p>reference counted binaries</p></li>
<li><p>stacktraces</p></li>
<li><p>symmetric multi-processing (SMP)</p></li>
</ul>
<p>In addition, several features are supported specifically for integration with micro-controllers, including:</p>
<ul class="simple">
<li><p>Wifi networking (<a class="reference internal" href="network-programming-guide.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">network</span></code></span></a>)</p></li>
<li><p><a class="reference internal" href="#udp">UDP</a> and <a class="reference internal" href="#tcp">TCP/IP</a> support (<a class="reference internal" href="apidocs/erlang/estdlib/inet.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">inet</span></code></span></a>, <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/gen_udp.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_udp</span></code></span></a>)</p></li>
<li><p><a class="reference internal" href="#peripherals">Peripheral</a> and system support on micro-controllers, including</p>
<ul>
<li><p><a class="reference internal" href="#gpio">GPIO</a>, including pins reads, writes, and interrupts</p></li>
<li><p><a class="reference internal" href="#i2c">I2C</a> interface</p></li>
<li><p><a class="reference internal" href="#spi">SPI</a> interface</p></li>
<li><p><a class="reference internal" href="#uart">UART</a> interface</p></li>
<li><p><a class="reference internal" href="#led-control">LEDC</a> (PWM)</p></li>
<li><p><a class="reference internal" href="#non-volatile-storage">non-volatile storage</a> (NVS)</p></li>
<li><p><a class="reference internal" href="#rtc-memory">RTC</a> storage</p></li>
<li><p><a class="reference internal" href="#restart-and-deep-sleep">deep sleep</a></p></li>
</ul>
</li>
</ul>
<section id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Link to this heading"></a></h3>
<p>While the list of supported features is long and growing, the currently unsupported Erlang/OTP and BEAM features include (but are not limited to):</p>
<ul class="simple">
<li><p>Atoms. Atoms larger than 255 bytes (255 ascii characters) are not supported.</p></li>
<li><p>Bignums.  Integer values are restricted to 64-bit values.</p></li>
<li><p>Bit Syntax.  While packing and unpacking of arbitrary (but less than 64-bit) bit values is supported, packing and unpacking of integer values at the start or end of a binary, or bordering binary packing or extraction must align on 8-bit boundaries.  Arbitrary bit length binaries are not currently supported.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">epmd</span></code> and the <code class="docutils literal notranslate"><span class="pre">disterl</span></code> protocols are not supported.</p></li>
<li><p>There is no support for code hot swapping.</p></li>
<li><p>There is no support for a Read-Eval-Print-Loop. (REPL)</p></li>
<li><p>Numerous modules and functions from Erlang/OTP standard libraries (<code class="docutils literal notranslate"><span class="pre">kernel</span></code>, <code class="docutils literal notranslate"><span class="pre">stdlib</span></code>, <code class="docutils literal notranslate"><span class="pre">sasl</span></code>, etc) are not implemented.</p></li>
</ul>
<p>AtomVM bit syntax is restricted to alignment on 8-bit boundaries.  Little-endian and signed insertion and extraction of integer values is restricted to 8, 16, and 32-bit values.  Only unsigned big and little endian 64-bit values can be inserted into or extracted from binaries.</p>
<p>It is highly unlikely that an existing Erlang program targeted for Erlang/OTP will run unmodified on AtomVM.  And indeed, even as AtomVM matures and additional features are added, it is more likely than not that Erlang applications will need to targeted specifically for the AtomVM platform.  The intended target environment (small, cheap micro-controllers) differs enough from desktop or server-class systems in both scale and APIs that special care and attention is needed to target applications for such embedded environments.</p>
<p>That being said, many of the features of the BEAM are supported and provide a rich and compelling development environment for embedded devices, which Erlang and Elixir developers will find natural and productive.</p>
</section>
</section>
<section id="atomvm-development">
<h2>AtomVM Development<a class="headerlink" href="#atomvm-development" title="Link to this heading"></a></h2>
<p>This section describes the typical development environment and workflow most AtomVM developers are most likely to use.</p>
<section id="development-environment">
<h3>Development Environment<a class="headerlink" href="#development-environment" title="Link to this heading"></a></h3>
<p>In general, for most development purposes, you should be able to get away with an Erlang/OTP development environment, and for Elixir developers, and Elixir development environment.  For specific version requirements, see the <a class="reference internal" href="release-notes.html"><span class="std std-doc">Release Notes</span></a>.</p>
<p>We assume most development will take place on some UNIX-like environment (e.g., Linux, FreeBSD, or MacOS).  Consult your local package manager for installation of these development environments.</p>
<p>Developers will want to make use of common Erlang or Elixir development tools, such as <code class="docutils literal notranslate"><span class="pre">rebar3</span></code> for Erlang developers or <code class="docutils literal notranslate"><span class="pre">mix</span></code> for Elixir developers.</p>
<p>Developers will need to make use of some AtomVM tooling.  Fortunately, there are several choices for developers to use:</p>
<ol class="arabic simple">
<li><p>AtomVM <code class="docutils literal notranslate"><span class="pre">PackBEAM</span></code> executable (described below)</p></li>
<li><p><a class="reference external" href="https://github.com/atomvm/atomvm_rebar3_plugin"><code class="docutils literal notranslate"><span class="pre">atomvm_rebar3_plugin</span></code></a>, for Erlang development using <a class="reference external" href="https://rebar3.readme.io"><code class="docutils literal notranslate"><span class="pre">rebar3</span></code></a>.</p></li>
<li><p><a class="reference external" href="https://github.com/atomvm/ExAtomVM"><code class="docutils literal notranslate"><span class="pre">ExAtomVM</span></code></a> Mix plugin, Elixir development using <a class="reference external" href="https://elixir-lang.org/getting-started/mix-otp/introduction-to-mix.html"><code class="docutils literal notranslate"><span class="pre">Mix</span></code></a>.</p></li>
</ol>
<p>Some testing can be performed on UNIX-like systems, using the <code class="docutils literal notranslate"><span class="pre">AtomVM</span></code> executable that is suitable for your development environment.  AtomVM applications that do not make use of platform-specific APIs are suitable for such tests.</p>
<p>Deployment and testing on micro-controllers is slightly more involved, as these platforms require additional hardware and software, described below.</p>
<section id="esp32-deployment-requirements">
<h4>ESP32 Deployment Requirements<a class="headerlink" href="#esp32-deployment-requirements" title="Link to this heading"></a></h4>
<p>In order to deploy AtomVM applications to and test on the ESP32 platform, developers will need:</p>
<ul class="simple">
<li><p>A computer running MacOS or Linux (Windows support is TBD);</p></li>
<li><p>An ESP32 module with a USB/UART connector (typically part of an ESP32 development board);</p></li>
<li><p>A USB cable capable of connecting the ESP32 module or board to your development machine (laptop or PC);</p></li>
<li><p>The <a class="reference external" href="https://github.com/espressif/esptool"><code class="docutils literal notranslate"><span class="pre">esptool</span></code></a> program, for flashing the AtomVM image and AtomVM programs;</p></li>
<li><p>(Optional, but recommended) A serial console program, such as <code class="docutils literal notranslate"><span class="pre">minicom</span></code> or <code class="docutils literal notranslate"><span class="pre">screen</span></code>, so that you can view console output from your AtomVM application.</p></li>
</ul>
</section>
<section id="stm32-deployment-requirements">
<h4>STM32 Deployment Requirements<a class="headerlink" href="#stm32-deployment-requirements" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>A computer running MacOS or Linux (Windows is not currently supported);</p></li>
<li><p>An stm32 board with a USB/UART connector (these are built into some boards such as the Nucleo product line) and a minimum of 512k (1M recommended) of flash and a minimum of 100k RAM;</p></li>
<li><p>A USB cable capable of connecting the STM32 board or external UART connector to your development machine (laptop or PC);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">st-flash</span></code> via <a class="reference external" href="https://github.com/stlink-org/stlink">stlink</a>, to flash both AtomVM and your packed AVM applications. Make sure to follow its <a class="reference external" href="https://github.com/stlink-org/stlink#installation">installation procedure</a> before proceeding further.</p></li>
<li><p><a class="reference external" href="https://github.com/atomvm/atomvm_packbeam"><code class="docutils literal notranslate"><span class="pre">packbeam</span></code></a> the AtomVM for packing and stripping <code class="docutils literal notranslate"><span class="pre">*.beam</span></code> files into the AtomVM <code class="docutils literal notranslate"><span class="pre">*.avm</span></code> format.</p></li>
<li><p>(Optional, but recommended) A serial console program, such as <code class="docutils literal notranslate"><span class="pre">minicom</span></code> or <code class="docutils literal notranslate"><span class="pre">screen</span></code>, so that you can view console output from your AtomVM application.</p></li>
</ul>
</section>
<section id="raspberry-pi-pico-deployment-requirements">
<h4>Raspberry Pi Pico Deployment Requirements<a class="headerlink" href="#raspberry-pi-pico-deployment-requirements" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>A computer running MacOS or Linux (Windows support is not currently supported);</p></li>
<li><p>A Raspberry Pico board with a USB/UART connector (typically part of a development board);</p></li>
<li><p>A USB cable capable of connecting the Raspberry Pico module or board to your development machine (laptop or PC);</p></li>
<li><p>(Optional, but recommended) A serial console program, such as <code class="docutils literal notranslate"><span class="pre">minicom</span></code> or <code class="docutils literal notranslate"><span class="pre">screen</span></code>, so that you can view console output from your AtomVM application.</p></li>
</ul>
</section>
</section>
<section id="development-workflow">
<h3>Development Workflow<a class="headerlink" href="#development-workflow" title="Link to this heading"></a></h3>
<p>For the majority of users, AtomVM applications are written in the Erlang or Elixir programming language.  These applications are compiled to BEAM (<code class="docutils literal notranslate"><span class="pre">.beam</span></code>) files using standard Erlang or Elixir compiler tool chains (<code class="docutils literal notranslate"><span class="pre">erlc</span></code>, <code class="docutils literal notranslate"><span class="pre">rebar3</span></code>, <code class="docutils literal notranslate"><span class="pre">mix</span></code>, etc).  The generated BEAM files contain byte-code that can be executed by the Erlang/OTP runtime, or by the AtomVM virtual machine.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a small number of cases, it may be useful to write parts of an application in the C programming language, as
AtomVM nifs or ports.  However, writing AtomVM nifs and ports is outside of the scope of this document.</p>
</div>
<p>Once Erlang and/or Elixir files are compiled to BEAM files, AtomVM provides tooling for processing and aggregating BEAM files into AtomVM Packbeam (<code class="docutils literal notranslate"><span class="pre">.avm</span></code>) files, using AtomVM tooling, distributed as part of AtomVM, or as provided through the AtomVM community.</p>
<p>AtomVM packbeam files are the applications and libraries that run on the AtomVM virtual machine.  For micro-controller devices, they are “flashed” or uploaded to the device; for command-line use of AtomVM (e.g., on Linux, FreeBSD, or MacOS), they are supplied as the first parameter to the AtomVM command.</p>
<p>The following diagram illustrates the typical development workflow, starting from Erlang or Elixir source code, and resulting in a deployed Packbeam file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*.erl or *.ex                  *.beam
+-------+                   +-------+
|       |+                  |       |+
|       ||+                 |       ||+
|       |||     --------&gt;   |       |||
|       |||  Erlang/Elixir  |       |||
+-------+||     Compiler    +-------+||
 +-------+|                  +-------+|
  +-------+                   +-------+
     ^                           |
     |                           | packbeam
     |                           |
     |                           v
     |                       +-------+
     |                       |       |
     | test                  |       |
     | debug                 |       |
     | fix                   |       |
     |                       +-------+
     |                        app.avm
     |                           |
     |                           | flash/upload
     |                           |
     |                           v
     +-------------------- Micro-controller
                              device
</pre></div>
</div>
<p>The typical compile-test-debug cycle can be summarized in the following steps:</p>
<ol class="arabic simple">
<li><p>Deploy the AtomVM virtual machine to your device</p></li>
<li><p>Develop an AtomVM application in Erlang or Elixir</p>
<ol class="arabic simple">
<li><p>Write application</p></li>
<li><p>Deploy application to device</p></li>
<li><p>Test/Debug/Fix application</p></li>
<li><p>Repeat</p></li>
</ol>
</li>
</ol>
<p>Deployment of the AtomVM virtual machine and an AtomVM application currently require a USB serial connection.  There is currently no support for over-the-air (OTA) updates.</p>
<p>For more information about deploying the AtomVM image and AtomVM applications to your device, see the <a class="reference internal" href="getting-started-guide.html"><span class="std std-doc">Getting Started Guide</span></a></p>
</section>
</section>
<section id="applications">
<h2>Applications<a class="headerlink" href="#applications" title="Link to this heading"></a></h2>
<p>An AtomVM application is a collection of BEAM files, aggregated into an AtomVM “Packbeam” (<code class="docutils literal notranslate"><span class="pre">.avm</span></code>) file, and typically deployed (flashed) to some device.  These BEAM files be be compiled from Erlang, Elixir, or any other language that targets the Erlang VM.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The return value from the <code class="docutils literal notranslate"><span class="pre">start/0</span></code> function is ignored on the the <code class="docutils literal notranslate"><span class="pre">generic_unix</span></code> platform, most MCU platforms have
the option of rebooting the device if the <code class="docutils literal notranslate"><span class="pre">start/0</span></code> function returns a value other than <code class="docutils literal notranslate"><span class="pre">ok</span></code>. Consult the
<a class="reference internal" href="build-instructions.html#platform-specific-build-instructions"><span class="std std-ref">Build Instructions</span></a> for your device to see how this
is configured.</p>
</div>
<p>Here, for example is one of the smallest AtomVM applications you can write:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">myapp</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">ok</span><span class="p">.</span>
</pre></div>
</div>
<p>This particular application doesn’t do much, of course.  The application will start and immediately terminate, with a return value of <code class="docutils literal notranslate"><span class="pre">ok</span></code>.  Typical AtomVM applications will be more complex than this one, and the AVM file that contains the application BEAM files will be considerably larger and more complex than the above program.</p>
<p>Most applications will spawn processes, send and receive messages between processes, and
wait for certain conditions to apply before terminating, if they terminate at all.  For applications
that spawn processes and run forever, you may need to add an empty <code class="docutils literal notranslate"><span class="pre">receive</span> <span class="pre">...</span> <span class="pre">end</span></code> block, to
prevent the AtomVM from terminating prematurely, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">wait_forever</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="k">receive</span><span class="w"> </span><span class="nv">X</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nv">X</span><span class="w"> </span><span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<section id="packbeam-files">
<h3>Packbeam files<a class="headerlink" href="#packbeam-files" title="Link to this heading"></a></h3>
<p>AtomVM applications are packaged into Packbeam (<code class="docutils literal notranslate"><span class="pre">.avm</span></code>) files, which contain collections of files, typically BEAM (<code class="docutils literal notranslate"><span class="pre">.beam</span></code>) files that have been generated by the Erlang or Elixir compiler.</p>
<p>At least one BEAM module in this file must contain an exported <code class="docutils literal notranslate"><span class="pre">start/0</span></code> function.  The first module in a Packbeam file that contain this function is the entry-point of your application and will be executed when the AtomVM virtual machine starts.</p>
<p>Not all files in a Packbeam need to be BEAM modules – you can embed any type of file in a Packbeam file, for consumption by your AtomVM application.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>The Packbeam format is described in more detail in the AtomVM <a class="reference internal" href="packbeam-format.html"><span class="std std-doc">PackBEAM format</span></a>.</p>
</div>
<p>The AtomVM community has provided several tools for simplifying your experience, as a developer.  These tools allow you to use standard Erlang and Elixir tooling (such as <code class="docutils literal notranslate"><span class="pre">rebar3</span></code> and <code class="docutils literal notranslate"><span class="pre">mix</span></code>) to build Packbeam files and deploy then to your device of choice.</p>
</section>
<section id="packbeam-tool">
<h3>packbeam tool<a class="headerlink" href="#packbeam-tool" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">packbeam</span></code> tool is a command-line application that can be used to create Packbeam files from a collection of input files:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>packbeam<span class="w"> </span><span class="nb">help</span>
packbeam<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.7.0
Syntax:
<span class="w">    </span>packbeam<span class="w"> </span>&lt;sub-command&gt;<span class="w"> </span>&lt;options&gt;<span class="w"> </span>&lt;args&gt;

The<span class="w"> </span>following<span class="w"> </span>sub-commands<span class="w"> </span>are<span class="w"> </span>supported:

<span class="w">    </span>create<span class="w"> </span>&lt;options&gt;<span class="w"> </span>&lt;output-avm-file&gt;<span class="w"> </span><span class="o">[</span>&lt;input-file&gt;<span class="o">]</span>+
<span class="w">        </span>where:
<span class="w">            </span>&lt;output-avm-file&gt;<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>AVM<span class="w"> </span>file,
<span class="w">            </span><span class="o">[</span>&lt;input-file&gt;<span class="o">]</span>+<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>input<span class="w"> </span>files,
<span class="w">            </span>and<span class="w"> </span>&lt;options&gt;<span class="w"> </span>are<span class="w"> </span>among<span class="w"> </span>the<span class="w"> </span>following:
<span class="w">                </span><span class="o">[</span>--prune<span class="p">|</span>-p<span class="o">]</span><span class="w">           </span>Prune<span class="w"> </span>dependencies
<span class="w">                </span><span class="o">[</span>--start<span class="p">|</span>-s<span class="w"> </span>&lt;module&gt;<span class="o">]</span><span class="w">  </span>Start<span class="w"> </span>module
<span class="w">                </span><span class="o">[</span>--remove_lines<span class="p">|</span>-r<span class="o">]</span><span class="w">    </span>Remove<span class="w"> </span>line<span class="w"> </span>number<span class="w"> </span>information<span class="w"> </span>from<span class="w"> </span>AVM<span class="w"> </span>files

<span class="w">    </span>list<span class="w"> </span>&lt;options&gt;<span class="w"> </span>&lt;avm-file&gt;
<span class="w">        </span>where:
<span class="w">            </span>&lt;avm-file&gt;<span class="w"> </span>is<span class="w"> </span>an<span class="w"> </span>AVM<span class="w"> </span>file,
<span class="w">            </span>and<span class="w"> </span>&lt;options&gt;<span class="w"> </span>are<span class="w"> </span>among<span class="w"> </span>the<span class="w"> </span>following:
<span class="w">                </span><span class="o">[</span>--format<span class="p">|</span>-f<span class="w"> </span>csv<span class="p">|</span>bare<span class="p">|</span>default<span class="o">]</span><span class="w">  </span>Format<span class="w"> </span>output

<span class="w">    </span>extract<span class="w"> </span>&lt;options&gt;<span class="w"> </span>&lt;avm-file&gt;<span class="w"> </span><span class="o">[</span>&lt;element&gt;<span class="o">]</span>*
<span class="w">        </span>where:
<span class="w">            </span>&lt;avm-file&gt;<span class="w"> </span>is<span class="w"> </span>an<span class="w"> </span>AVM<span class="w"> </span>file,
<span class="w">            </span><span class="o">[</span>&lt;element&gt;<span class="o">]</span>+<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>elements<span class="w"> </span>to<span class="w"> </span>extract
<span class="w">                </span><span class="o">(</span><span class="k">if</span><span class="w"> </span>empty,<span class="w"> </span><span class="k">then</span><span class="w"> </span>extract<span class="w"> </span>all<span class="w"> </span>elements<span class="o">)</span>
<span class="w">            </span>and<span class="w"> </span>&lt;options&gt;<span class="w"> </span>are<span class="w"> </span>among<span class="w"> </span>the<span class="w"> </span>following:
<span class="w">                </span><span class="o">[</span>--out<span class="p">|</span>-o<span class="w"> </span>&lt;output-directory&gt;<span class="o">]</span><span class="w">   </span>Output<span class="w"> </span>directory<span class="w"> </span>into<span class="w"> </span>which<span class="w"> </span>to<span class="w"> </span>write<span class="w"> </span>elements
<span class="w">                </span><span class="o">(</span><span class="k">if</span><span class="w"> </span>unspecified,<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span>current<span class="w"> </span>working<span class="w"> </span>directory<span class="o">)</span>

<span class="w">    </span>delete<span class="w"> </span>&lt;options&gt;<span class="w"> </span>&lt;avm-file&gt;<span class="w"> </span><span class="o">[</span>&lt;element&gt;<span class="o">]</span>+
<span class="w">        </span>where:
<span class="w">            </span>&lt;avm-file&gt;<span class="w"> </span>is<span class="w"> </span>an<span class="w"> </span>AVM<span class="w"> </span>file,
<span class="w">            </span><span class="o">[</span>&lt;element&gt;<span class="o">]</span>+<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>elements<span class="w"> </span>to<span class="w"> </span>delete,
<span class="w">            </span>and<span class="w"> </span>&lt;options&gt;<span class="w"> </span>are<span class="w"> </span>among<span class="w"> </span>the<span class="w"> </span>following:
<span class="w">                </span><span class="o">[</span>--out<span class="p">|</span>-o<span class="w"> </span>&lt;output-avm-file&gt;<span class="o">]</span><span class="w">    </span>Output<span class="w"> </span>AVM<span class="w"> </span>file

<span class="w">    </span>version
<span class="w">        </span>Print<span class="w"> </span>version<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span>

<span class="w">    </span><span class="nb">help</span>
<span class="w">        </span>Print<span class="w"> </span>this<span class="w"> </span><span class="nb">help</span>
</pre></div>
</div>
<p>For more information consult the <a class="reference internal" href="atomvm-tooling.html#atomvm-packbeam"><span class="std std-ref">packbeam section of AtomVM Tooling</span></a>.</p>
</section>
<section id="running-atomvm">
<h3>Running <code class="docutils literal notranslate"><span class="pre">AtomVM</span></code><a class="headerlink" href="#running-atomvm" title="Link to this heading"></a></h3>
<p>AtomVM is executed in different ways, depending on the platform.  On most microcontrollers (e.g., the ESP32), the VM starts when the device is powered on.  On UNIX platforms, the VM is started from the command-line using the <code class="docutils literal notranslate"><span class="pre">AtomVM</span></code> executable.</p>
<p>AtomVM will use the first module in the supplied AVM file that exports a <code class="docutils literal notranslate"><span class="pre">start/0</span></code> function as the entrypoint for the application.</p>
<section id="atomvm-program-syntax">
<h4><code class="docutils literal notranslate"><span class="pre">AtomVM</span></code> program syntax<a class="headerlink" href="#atomvm-program-syntax" title="Link to this heading"></a></h4>
<p>On UNIX platforms, you can specify a BEAM file or AVM file as the first argument to the executable, e.g.,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>AtomVM<span class="w"> </span>foo.avm
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you start the <code class="docutils literal notranslate"><span class="pre">AtomVM</span></code> executable with a BEAM file, then the corresponding module may not make any calls to
external function in other modules, with the exception of built-in functions and Nifs that are included in the VM.</p>
</div>
</section>
</section>
</section>
<section id="core-apis">
<h2>Core APIs<a class="headerlink" href="#core-apis" title="Link to this heading"></a></h2>
<p>The AtomVM virtual machine provides a set of Erlang built-in functions (BIFs) and native functions (NIFs), as well as a collection of Erlang and Elixir libraries that can be used from your applications.</p>
<p>This section provides an overview of these APIs.  For more detailed information about specific APIs, please consult the <a class="reference internal" href="api-reference-documentation.html"><span class="std std-doc">API reference documentation</span></a>.</p>
<section id="standard-libraries">
<h3>Standard Libraries<a class="headerlink" href="#standard-libraries" title="Link to this heading"></a></h3>
<p>AtomVM provides a limited implementations of standard library modules, including:</p>
<ul class="simple">
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/base64.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">base64</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/gen_server.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_server</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/gen_statem.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_statem</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/io.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">io</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/io_lib.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">io_lib</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/lists.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">lists</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/maps.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">maps</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/proplists.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">proplists</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/supervisor.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">supervisor</span></code></span></a></p></li>
<li><p><a class="reference internal" href="apidocs/erlang/estdlib/timer.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">timer</span></code></span></a></p></li>
</ul>
<p>In addition AtomVM provides limited implementations of standard Elixir modules, including:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">List</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tuple</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Enum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Kernel</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Module</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Process</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Console</span></code></p></li>
</ul>
<p>For detailed information about these functions, please consult the <a class="reference internal" href="api-reference-documentation.html"><span class="std std-doc">API reference documentation</span></a>.  These modules provide a strict subset of functionality from their Erlang/OTP counterparts.  However, they aim to be API-compatible with the Erlang/OTP interfaces, at least for the subset of provided functionality.</p>
</section>
<section id="spawning-processes">
<h3>Spawning Processes<a class="headerlink" href="#spawning-processes" title="Link to this heading"></a></h3>
<p>AtomVM supports the actor concurrency model that is pioneered in the Erlang/OTP runtime.  As such, users can spawn processes, send messages to and receive message from processes, and can link or monitor processes to be notified if they have crashed.</p>
<p>To spawn a process using a defined or anonymous function, pass the function to the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#spawn-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spawn/1</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="w"> </span><span class="n">run_some_code</span><span class="o">/</span><span class="mi">0</span><span class="p">),</span>
</pre></div>
</div>
<p>The function you pass may admit closures, so for example you can pass variables defined outside of the scope of the function to the anonymous function to pass into <code class="docutils literal notranslate"><span class="pre">spawn/1</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="nv">Pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">run_some_code_with_args</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span><span class="w"> </span><span class="k">end</span><span class="p">),</span>
</pre></div>
</div>
<p>Alternatively, you can pass a module, function name, and list of arguments to the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#spawn-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spawn/3</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="nv">Pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">spawn</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">run_some_code_with_args</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Args</span><span class="p">]),</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#spawn-opt-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spawn_opt/2,4</span></code></span></a> functions can be be used to spawn a function with additional options that control the behavior of the spawned processes, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">spawn_opt</span><span class="p">(</span><span class="k">fun</span><span class="w"> </span><span class="n">run_some_code</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="w"> </span><span class="mi">1342</span><span class="p">}]),</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#spawn-option"><span class="std std-ref">options</span></a> argument is a properties list containing optionally the following entries:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">min_heap_size</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>none</p></td>
<td><p>Minimum heap size of the process.  The heap will shrink no smaller than this size.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">max_heap_size</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>unbounded</p></td>
<td><p>Maximum heap size of the process.  The heap will grow no larger than this size.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">link</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">boolean()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Whether to link the spawned process to the spawning process.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">monitor</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">boolean()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Whether to link the spawning process should monitor the spawned process.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">atomvm_heap_growth</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">bounded_free</span> <span class="pre">|</span> <span class="pre">minimum</span> <span class="pre">|</span> <span class="pre">fibonacci</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">bounded_free</span></code></p></td>
<td><p><a class="reference internal" href="memory-management.html#heap-growth-strategies"><span class="std std-ref">Strategy</span></a> to grow the heap of the process.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="console-output">
<h3>Console Output<a class="headerlink" href="#console-output" title="Link to this heading"></a></h3>
<p>There are several mechanisms for writing data to the console.</p>
<p>For common debugging, many users will find <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#display-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:display/1</span></code></span></a> sufficient for debugging:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">erlang</span><span class="p">:</span><span class="nb">display</span><span class="p">({</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">tapas</span><span class="p">}]}).</span>
</pre></div>
</div>
<p>The output parameter is any Erlang term, and a newline will be appended automatically.</p>
<p>Users may prefer using the <a class="reference internal" href="apidocs/erlang/estdlib/io.html#format-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">io:format/1,2</span></code></span></a> functions for more controlled output:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;The </span><span class="si">~p</span><span class="s"> did a </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">friddle</span><span class="p">,</span><span class="w"> </span><span class="n">frop</span><span class="p">]).</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <a class="reference internal" href="apidocs/erlang/estdlib/io_lib.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">io_lib</span></code></span></a> module can be used to format string data, as well.</p>
</div>
</section>
<section id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Link to this heading"></a></h3>
<p>AtomVM supports a subset of the OTP logging facility, allowing users to send log event to log handlers (by default, the console), and to install handlers that handle log events.</p>
<p>To log events, you are encouraged to use the logging macros from the OTP <code class="docutils literal notranslate"><span class="pre">kernel</span></code> application.  You can use these macros at compile time, and the generated code can be run in AtomVM.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&quot;kernel/include/logger.hrl&quot;</span><span class="p">).</span>
<span class="p">...</span>
<span class="o">?</span><span class="nv">LOG_NOTICE</span><span class="p">(</span><span class="s">&quot;Something happened that might require your attention: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">TheThing</span><span class="p">])</span>
</pre></div>
</div>
<p>By default, this will result in a message displayed on the console, with a timestamp, log level, PID of the process that initiated the log message, the module, function, and function arity, together with the supplied log message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>2023-07-04T18:34:56.387 [notice] &lt;0.1.0&gt; test_logger:test_default_logger/0 Something
happened that might require your attention: ThatThingThatHappened
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Note that log messages need not (and generally should not) include newline separators (<code class="docutils literal notranslate"><span class="pre">~n</span></code>) in log format messages,
unless necessary.</p>
</div>
<p>Users may provide a format string, with an optional list of arguments.  Alternatively, users can provide a map encapsulating a “report” in lieu of a format string.  Reports provide a mechanism for supplying a set of structured data directly to log handlers (see below), without necessarily incurring the cost of formatting log messages.</p>
<p>As with OTP, the following ordered log levels (from high to low) are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">emergency</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">critical</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alert</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">warning</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notice</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">info</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code></p></li>
</ul>
<p>By default, the logging facility drops any messages below <code class="docutils literal notranslate"><span class="pre">notice</span></code> level.  To set the default log level for the logging subsystem, see the <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> section, below.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">logger</span></code> interface directly to log messages at different levels, but in general, the OTP logging macros are encouraged, as log events generated using the OTP macros include additional metadata (such as the location of the log event) you do not otherwise get using the functions in the <a class="reference internal" href="apidocs/erlang/estdlib/logger.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">logger</span></code> module</span></a>.</p>
<p>For example, the expression</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">logger</span><span class="p">:</span><span class="nf">notice</span><span class="p">(</span><span class="s">&quot;Something happened that might require your attention: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">TheThing</span><span class="p">])</span>
</pre></div>
</div>
<p>may seem similar to using the <code class="docutils literal notranslate"><span class="pre">?LOG_NOTICE</span></code> macro, but less contextual information will be included in the log event.</p>
<p>For more information about the OTP logging facility, see the Erlang/OTP <a class="reference external" href="https://www.erlang.org/doc/apps/kernel/logger_chapter.html">Logging</a> chapter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>AtomVM does not currently support programmatic configuration of the logging subsystem.  All changes to default
behavior should be done via the AtomVM <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> module (see below).</p>
</div>
<section id="the-logger-manager">
<h4>The <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code><a class="headerlink" href="#the-logger-manager" title="Link to this heading"></a></h4>
<p>In order to use the <code class="docutils literal notranslate"><span class="pre">logger</span></code> interface, you will need to first start the AtomVM <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> service.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Future versions of AtomVM may automatically start the logging subsystem as part of a kernel application, but
currently, this service must be managed manually.</p>
</div>
<p>To start the <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code>, use the <code class="docutils literal notranslate"><span class="pre">logger_manager:start_link/1</span></code> function, passing in a configuration map for the logging subsystem.</p>
<p>For example, the default logging framework can be started via:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Pid</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">logger_manager</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(#{})</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The logger_manager is a registered process, so the returned Pid may be ignored.</p>
</div>
<p>The configuration map supplied to the logger_manager may contain the following keys:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">log_level</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">log_level()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">notice</span></code></p></td>
<td><p>Primary log level</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">logger</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">logger_config()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{handler,</span> <span class="pre">default,</span> <span class="pre">logger_std_h,</span> <span class="pre">#{}}</span></code></p></td>
<td><p>Log configuration</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">module_level</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">module_level()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">undefined</span></code></p></td>
<td><p>Log level specific to a set of modules</p></td>
</tr>
</tbody>
</table>
<p>where <code class="docutils literal notranslate"><span class="pre">log_level()</span></code> is defined to be:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">log_level</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">emergency</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">notice</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">debug</span><span class="p">.</span>
</pre></div>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">logger_config()</span></code> is defined as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">handler_id</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">atom</span><span class="p">().</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">handler_config</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">#{</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">atom</span><span class="p">(),</span>
<span class="w">    </span><span class="n">module</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">module</span><span class="p">(),</span>
<span class="w">    </span><span class="n">level</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">logger</span><span class="p">:</span><span class="nf">level</span><span class="p">()</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">none</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">term</span><span class="p">()</span>
<span class="p">}.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">logger_config</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="p">,</span><span class="w"> </span><span class="n">undefined</span><span class="p">}</span><span class="w"> </span><span class="p">|</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">handler</span><span class="p">,</span>
<span class="w">        </span><span class="nv">HandlerId</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">handler_id</span><span class="p">(),</span>
<span class="w">        </span><span class="nv">Handler</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">module</span><span class="p">(),</span>
<span class="w">        </span><span class="nv">HandlerConfig</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">handler_config</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">|</span>
<span class="w">    </span><span class="p">{</span><span class="n">module_level</span><span class="p">,</span><span class="w"> </span><span class="nn">logger</span><span class="p">:</span><span class="nf">level</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="n">module</span><span class="p">()]}</span>
<span class="p">].</span>
</pre></div>
</div>
<p>You can set the log level for all log handlers by setting the <code class="docutils literal notranslate"><span class="pre">log_level</span></code> in this configuration map.  Any messages that are logged at levels “higher” than or equal to the configured log level will be logged by all log handlers.</p>
<p>The standard logger (<code class="docutils literal notranslate"><span class="pre">logger_std_h</span></code>) is included by default, if no default logger is specified (and if the default logger is not disabled – see below).  The standard logger will output log events to the console.</p>
<p>You can specify multiple log handlers in the <code class="docutils literal notranslate"><span class="pre">logger</span></code> configuration.  If a log entry is allowed for a given log level, then each log handler will handle the log message.  For example, you might have a log handler that sends messages over the network to a syslog daemon, or you might have another handler that writes log messages to a file.</p>
<p>You can pass handler configuration int the <code class="docutils literal notranslate"><span class="pre">config</span></code> element of the <code class="docutils literal notranslate"><span class="pre">handler_config()</span></code> you specify when specifying a logger.  The value of the <code class="docutils literal notranslate"><span class="pre">config</span></code> element can be any term and is made available to log handlers when events are logged (see below).</p>
<p>If the tuple <code class="docutils literal notranslate"><span class="pre">{handler,</span> <span class="pre">default,</span> <span class="pre">undefined}</span></code> is included in the logger configuration, the default logger will be disabled.</p>
<p>At most one <code class="docutils literal notranslate"><span class="pre">default</span></code> logger can be specified.  If you want to replace the <code class="docutils literal notranslate"><span class="pre">default</span></code> logger (<code class="docutils literal notranslate"><span class="pre">logger_std_h</span></code>), then specify a logger with the handler id <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<p>You can specify different log levels for specific modules.  For example, if you want to set the default log level for all handlers to be <code class="docutils literal notranslate"><span class="pre">notice</span></code> or higher, you can set the log level for a given module to <code class="docutils literal notranslate"><span class="pre">info</span></code>, and all <code class="docutils literal notranslate"><span class="pre">info</span></code> and higher messages will be logged for that module or set of modules.  Conversely, you can “quiet” a module if it is particularly noisy by setting its level to something relatively high.</p>
<p>For more information about how to configure the logging subsystem, see the <a class="reference external" href="https://www.erlang.org/doc/apps/kernel/logger_chapter.html#kernel-configuration-parameters">Kernel Configuration Parameters</a> section of the OTP Logging chapter.</p>
<p>You can stop the <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> via the <code class="docutils literal notranslate"><span class="pre">logger_manager:stop/0</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">logger_manager</span><span class="p">:</span><span class="nf">stop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="writing-your-own-log-handler">
<h4>Writing your own log handler<a class="headerlink" href="#writing-your-own-log-handler" title="Link to this heading"></a></h4>
<p>Additional loggers can be enabled via handler specifications.  A handler module must implement and export the <code class="docutils literal notranslate"><span class="pre">log/2</span></code> function, which takes a log event and a term containing the configuration for the logger handler instance.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_module</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([...,</span><span class="w"> </span><span class="n">log</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">...]).</span>

<span class="nf">log</span><span class="p">(</span><span class="nv">LogEvent</span><span class="p">,</span><span class="w"> </span><span class="nv">HandlerConfig</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c">%% do something with the log event</span>
<span class="w">    </span><span class="c">%% return value is ignored</span>
</pre></div>
</div>
<p>You can specify this handler in the <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> configuration (see above) via a stanza such as:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">my_id</span><span class="p">,</span><span class="w"> </span><span class="n">my_module</span><span class="p">,</span><span class="w"> </span><span class="nv">HandlerConfig</span><span class="p">}</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">LogEvent</span></code> is a map structure containing the following fields:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>The time (in microseconds since the UNIX epoch) at which the log event was generated</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">level</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">logger:level()</span></code></p></td>
<td><p>The log level with which the log event was generated</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pid</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pid()</span></code></p></td>
<td><p>The process id of the Erlang process in which the event was generated</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">msg</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">{string(),</span> <span class="pre">list()}</span></code></p></td>
<td><p>The message format and arguments passed when the event was generated</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">meta</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">map()</span></code></p></td>
<td><p>Metadata passed when the event was generated.</p></td>
</tr>
</tbody>
</table>
<p>If the log event was generated using a logging macro, then the <code class="docutils literal notranslate"><span class="pre">meta</span></code> map also contains a <code class="docutils literal notranslate"><span class="pre">location</span></code> field with the following fields:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">file</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span></code></p></td>
<td><p>The path of the file in which the event was generated</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">line</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>The line number in the file in which the event was generated</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mfa</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{module(),</span> <span class="pre">function_name(),</span> <span class="pre">arity()}</span></code></p></td>
<td><p>The MFA of the function in which the event was generated</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">HandlerConfig</span></code> is a map structure containing the id and module of the handler and is passed into the log handler via configuration of the <code class="docutils literal notranslate"><span class="pre">logger_manager</span></code> (see above).</p>
</section>
</section>
<section id="process-management">
<h3>Process Management<a class="headerlink" href="#process-management" title="Link to this heading"></a></h3>
<p>You can obtain a list of all processes in the system via <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#processes-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:processes/0</span></code></span></a>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">().</span>
</pre></div>
</div>
<p>And for each process, you can get detailed process information via the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#process-info-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:process_info/2</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Heap size for Pid </span><span class="si">~p</span><span class="s">: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pid</span><span class="p">,</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span><span class="w"> </span><span class="n">heap_size</span><span class="p">)]).</span>
</pre></div>
</div>
<p>The return value is a tuple containing the key passed into the <code class="docutils literal notranslate"><span class="pre">erlang:process_info/2</span></code> function and its associated value.</p>
<p>The currently supported keys are enumerated in the following table:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">heap_size</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Number of terms (in machine words) used in the process heap</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">stack_size</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Number of terms (in machine words) used in the process stack</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">message_queue_len</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Number of unprocessed messages in the process mailbox</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">memory</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Total number of bytes used by the process (estimate)</p></td>
</tr>
</tbody>
</table>
<p>See the <code class="docutils literal notranslate"><span class="pre">word_size</span></code> key in the <a class="reference internal" href="#system-apis">System APIs</a> section for information about how to find the number of bytes used in a machine word on the current platform.</p>
</section>
<section id="external-term-format">
<h3>External Term Format<a class="headerlink" href="#external-term-format" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">erlang:term_to_binary/1</span></code> function can be used to serialize arbitrary term data into and out of binary data.  These operations can be useful for applications that wish to share term data over some network protocol, such as HTTP or MQTT, or wish to store serialized term data in some permanant sttorage (e.g., Non-volatile storage on ESP32 devices).</p>
<p>For example, to convert a term to a binary, use <code class="docutils literal notranslate"><span class="pre">erlang:term_to_binary/1</span></code>, e.g.,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%% erlang
Term = ...
Binary = erlang:term_to_binary(Term),
</pre></div>
</div>
<p>And to convert the binary back to a term, use <code class="docutils literal notranslate"><span class="pre">erlang:binary_to_term/1,2</span></code>, e.g.,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%% erlang
Binary = ...
{Term, _Used} = erlang:binary_to_term(Binary, [used]),
</pre></div>
</div>
<p>By default, AtomVM will encode all atoms using UTF-8 encoding.  This encoding is the default encoding for OTP-26 and later releases.</p>
<p>For more information about Erlang external term format, consult the <a class="reference external" href="https://www.erlang.org/doc/apps/erts/erl_ext_dist.html">Erlang Documentation</a></p>
</section>
<section id="system-apis">
<h3>System APIs<a class="headerlink" href="#system-apis" title="Link to this heading"></a></h3>
<p>You can obtain system information about the AtomVM virtual machine via the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#system-info-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:system_info/1</span></code></span></a> function, which takes an atom parameter designating the desired datum.  Allowable parameters include</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">process_count</span></code> The number of processes running in the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port_count</span></code> The number of ports running in the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">atom_count</span></code> The number of atoms allocated in the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">word_size</span></code> The word size (in bytes) on the current platform (typically 4 or 8).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">atomvm_version</span></code> The version of AtomVM currently running (as a binary).</p></li>
</ul>
<p>For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Atom Count: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">atom_count</span><span class="p">)]).</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Additional platform-specific information is supported, depending on the platform type.  See below.</p>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#platform-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:platform/0</span></code></span></a> to obtain the system platform on which your code is running.  The return value of this function is an atom who’s value will depend on the platform on which your application is running.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">platform</span><span class="p">()</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">esp32</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;I am running on an ESP32!</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">stm32</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;I am running on an STM32!</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">generic_unix</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;I am running on a UNIX box!</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#garbage-collect-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:garbage_collect/0</span></code></span></a> or <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#garbage-collect-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:garbage_collect/1</span></code></span></a> to force the AtomVM garbage collector to run on a give process.  Garbage collection will in general happen automatically when additional free space is needed and is rarely needed to be called explicitly.</p>
<p>The 0-arity version of this function will run the garbage collector on the currently executing process.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="c">%% get a reference to some pid</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nb">garbage_collect</span><span class="p">(</span><span class="nv">Pid</span><span class="p">).</span>
</pre></div>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#memory-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:memory/1</span></code></span></a> function to obtain information about allocated memory.</p>
<p>Currently, AtomVM supports the following types:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">binary</span></code></p></td>
<td><p>Return the total amount of memory (in bytes) occupied by (reference counted) binaries</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Binary data small enough to be stored in the Erlang process heap are not counted in this measurement.</p>
</div>
</section>
<section id="system-time">
<h3>System Time<a class="headerlink" href="#system-time" title="Link to this heading"></a></h3>
<p>AtomVM supports numerous function for accessing the current time on the device.</p>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#timestamp-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:timestamp/0</span></code></span></a> to get the current time since the UNIX epoch (Midnight, Jan 1, 1970, UTC), at microsecond granularity, expressed as a triple (mega-seconds, seconds, and micro-seconds):</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nv">MegaSecs</span><span class="p">,</span><span class="w"> </span><span class="nv">Secs</span><span class="p">,</span><span class="w"> </span><span class="nv">MicroSecs</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">timestamp</span><span class="p">().</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#system-time-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:system_time/1</span></code></span></a> to obtain the seconds, milliseconds or microseconds since the UNIX epoch (Midnight, Jan 1, 1970, UTC):</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p">(</span><span class="n">second</span><span class="p">).</span>
<span class="nv">MilliSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p">(</span><span class="n">millisecond</span><span class="p">).</span>
<span class="nv">MicroSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p">(</span><span class="n">microsecond</span><span class="p">).</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#monotonic-time-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:monotonic_time/1</span></code></span></a> to obtain a (possibly not strictly) monotonically increasing time measurement.  Use the same time units to convert to seconds, milliseconds, or microseconds:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p">(</span><span class="n">second</span><span class="p">).</span>
<span class="nv">MilliSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p">(</span><span class="n">millisecond</span><span class="p">).</span>
<span class="nv">MicroSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p">(</span><span class="n">microsecond</span><span class="p">).</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Note <code class="docutils literal notranslate"><span class="pre">erlang:monotonic_time/1</span></code> should not be used to calculate the wall clock time, but instead should be used by
applications to compute time differences in a manner that is independent of the system time on the device, which
might change, for example, due to NTP, leap seconds, or similar operations that may affect the wall time on the
device.</p>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#universaltime-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:universaltime/0</span></code></span></a> to get the current time at second resolution, to obtain the year, month, day, hour, minute, and second:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="nv">Year</span><span class="p">,</span><span class="w"> </span><span class="nv">Month</span><span class="p">,</span><span class="w"> </span><span class="nv">Day</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nv">Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">Minute</span><span class="p">,</span><span class="w"> </span><span class="nv">Second</span><span class="p">}}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nf">universaltime</span><span class="p">().</span>
</pre></div>
</div>
<p>On some platforms, you can use the <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#posix-clock-settime-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:posix_clock_settime/2</span></code></span></a> to set the system time.  Supply a clock id (currently, the only supported clock id is the atom <code class="docutils literal notranslate"><span class="pre">realtime</span></code>) and a time value as a tuple, containing seconds and nanoseconds since the UNIX epoch (midnight, January 1, 1970).  For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">SecondsSinceUnixEpoch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="c">%% acquire the time</span>
<span class="nn">atomvm</span><span class="p">:</span><span class="nf">posix_clock_settime</span><span class="p">(</span><span class="n">realtime</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">SecondsSinceUnixEpoch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This operation is not supported yet on the <code class="docutils literal notranslate"><span class="pre">stm32</span></code> platform.  On most UNIX platforms, you typically need <code class="docutils literal notranslate"><span class="pre">root</span></code>
permission to set the system time.</p>
</div>
<p>On the ESP32 platform, you can use the Wifi network to set the system time automatically.  For information about how to set system time on the ESP32 using SNTP, see the <a class="reference internal" href="network-programming-guide.html"><span class="std std-doc">Network Programming Guide</span></a>.</p>
<p>To convert a time (in seconds, milliseconds, or microseconds from the UNIX epoch) to a date-time, use the <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html#system-time-to-universal-time-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">calendar:system_time_to_universal_time/2</span></code></span></a> function.  For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Milliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="c">%% get milliseconds from the UNIX epoch</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="nv">Year</span><span class="p">,</span><span class="w"> </span><span class="nv">Month</span><span class="p">,</span><span class="w"> </span><span class="nv">Day</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nv">Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">Minute</span><span class="p">,</span><span class="w"> </span><span class="nv">Second</span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">calendar</span><span class="p">:</span><span class="nf">system_time_to_universal_time</span><span class="p">(</span><span class="nv">Milliseconds</span><span class="p">,</span><span class="w"> </span><span class="n">millisecond</span><span class="p">).</span>
</pre></div>
</div>
<p>Valid time units are <code class="docutils literal notranslate"><span class="pre">second</span></code>, <code class="docutils literal notranslate"><span class="pre">millisecond</span></code>, and <code class="docutils literal notranslate"><span class="pre">microsecond</span></code>.</p>
</section>
<section id="date-and-time">
<h3>Date and Time<a class="headerlink" href="#date-and-time" title="Link to this heading"></a></h3>
<p>A <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html#datetime"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">datetime()</span></code></span></a> is a tuple containing a date and time, where a date is a tuple containing the year, month, and day (in the <a class="reference external" href="https://en.wikipedia.org/wiki/Gregorian_calendar">Gregorian</a> calendar), expressed as integers, and a time is an hour, minute, and second, also expressed in integers.</p>
<p>The following Erlang type specification enumerates this type:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">year</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">integer</span><span class="p">().</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">month</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">1</span><span class="p">..</span><span class="mi">12</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">day</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">1</span><span class="p">..</span><span class="mi">31</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">date</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="n">year</span><span class="p">(),</span><span class="w"> </span><span class="n">month</span><span class="p">(),</span><span class="w"> </span><span class="n">day</span><span class="p">()}.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">gregorian_days</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">integer</span><span class="p">().</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">day_of_week</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">1</span><span class="p">..</span><span class="mi">7</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">hour</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">23</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">minute</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">59</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">second</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">59</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="n">hour</span><span class="p">(),</span><span class="w"> </span><span class="n">minute</span><span class="p">(),</span><span class="w"> </span><span class="n">second</span><span class="p">()}.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">datetime</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="n">date</span><span class="p">(),</span><span class="w"> </span><span class="n">time</span><span class="p">()}.</span>
</pre></div>
</div>
<p>Erlang/OTP uses the Christian epoch to count time units from year 0 in the Gregorian calendar.  The, for example, the value 0 in Gregorian seconds represents the date Jan 1, year 0, and midnight (UTC), or in Erlang terms, <code class="docutils literal notranslate"><span class="pre">{{0,</span> <span class="pre">1,</span> <span class="pre">1},</span> <span class="pre">{0,</span> <span class="pre">0,</span> <span class="pre">0}}</span></code>.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>AtomVM is currently limited to representing integers in at most 64 bits, with one bit representing the sign bit.
However, even with this limitation, AtomVM is able to resolve microsecond values in the Gregorian calendar for over
292,000 years, likely well past the likely lifetime of an AtomVM application (unless perhaps launched on a deep
space probe).</p>
</div>
<p>The <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">calendar</span></code> module</span></a> provides useful functions for converting dates to Gregorian days, and date-times to Gregorian seconds.</p>
<p>To convert a <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html#date"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">date()</span></code></span></a> to the number of days since January 1, year 0, use the <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html#date-to-gregorian-days-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">calendar:date_to_gregorian_days/1</span></code></span></a> function, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">GregorianDays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">calendar</span><span class="p">:</span><span class="nf">date_to_gregorian_days</span><span class="p">({</span><span class="mi">2023</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">})</span>
</pre></div>
</div>
<p>To convert a <code class="docutils literal notranslate"><span class="pre">datetime()</span></code> to convert the number of seconds since midnight January 1, year 0, use the <a class="reference internal" href="apidocs/erlang/estdlib/calendar.html#datetime-to-gregorian-seconds-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">calendar:datetime_to_gregorian_seconds/1</span></code></span></a> function, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">GregorianSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">calendar</span><span class="p">:</span><span class="nf">datetime_to_gregorian_seconds</span><span class="p">({{</span><span class="mi">2023</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">}})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">calendar</span></code> module does not support year values before year <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div>
</section>
<section id="miscellaneous-apis">
<h3>Miscellaneous APIs<a class="headerlink" href="#miscellaneous-apis" title="Link to this heading"></a></h3>
<p>Use <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#random-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:random/0</span></code></span></a> to generate a random unsigned 32-bit integer in the range <code class="docutils literal notranslate"><span class="pre">0..4294967295</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">RandomInteger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">random</span><span class="p">().</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/crypto.html#strong-rand-bytes-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">crypto:strong_rand_bytes/1</span></code></span></a> to return a randomly populated binary of a specified size:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">RandomBinary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">crypto</span><span class="p">:</span><span class="nf">strong_rand_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="apidocs/erlang/estdlib/base64.html#encode-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">base64:encode/1</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/base64.html#decode-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">base64:decode/1</span></code></span></a> to encode to and decode from Base64 format.  The input value to these functions may be a binary or string.  The output value from these functions is an Erlang binary.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">base64</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;foo&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;foo&quot;</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">base64</span><span class="p">:</span><span class="nf">decode</span><span class="p">(</span><span class="nv">Encoded</span><span class="p">).</span>
</pre></div>
</div>
<p>You can Use <a class="reference internal" href="apidocs/erlang/estdlib/base64.html#encode-to-string-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">base64:encode_to_string/1</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/base64.html#decode-to-string-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">base64:decode_to_string/1</span></code></span></a> to perform the same encoding, but to return values as Erlang list structures, instead of as binaries.</p>
</section>
<section id="stacktraces">
<h3>StackTraces<a class="headerlink" href="#stacktraces" title="Link to this heading"></a></h3>
<p>You can obtain information about the current state of a process via stacktraces, which provide information about the location of function calls (possibly including file names and line numbers) in your program.</p>
<p>Currently in AtomVM, stack traces can be obtained in one of following ways:</p>
<ul class="simple">
<li><p>via try-catch blocks</p></li>
<li><p>via catch blocks, when an error has been raised via the <code class="docutils literal notranslate"><span class="pre">error</span></code> Bif.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>AtomVM does not support <code class="docutils literal notranslate"><span class="pre">erlang:get_stacktrace/0</span></code> which was deprecated in Erlang/OTP 21 and 22, stopped working in
Erlang/OTP 23 and was removed in Erlang/OTP 24.  Support for accessing the current stacktrace via
<a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#process-info-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:process_info/2</span></code></span></a> may be added in the future.</p>
</div>
<p>For example a stack trace can be bound to a variable in the catch clause in a try-catch block:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">try</span>
<span class="w">    </span><span class="n">do_something</span><span class="p">()</span>
<span class="k">catch</span>
<span class="w">    </span><span class="p">_</span><span class="nv">Class</span><span class="p">:_</span><span class="nv">Error</span><span class="p">:</span><span class="nv">Stacktrace</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Stacktrace: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Stacktrace</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Alternatively, a stack trace can be bound to the result of a <code class="docutils literal notranslate"><span class="pre">catch</span></code> expression, but only when the error is raised by the <code class="docutils literal notranslate"><span class="pre">error</span></code> Bif.  For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">&#39;EXIT&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="nv">Stacktrace</span><span class="p">}}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">catch</span><span class="w"> </span><span class="n">error</span><span class="p">(</span><span class="n">foo</span><span class="p">)),</span>
<span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Stacktrace: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Stacktrace</span><span class="p">])</span>
</pre></div>
</div>
<p>Stack traces are printed to the console in a crash report, for example, when a process dies unexpectedly.</p>
<p>Stacktrace data is represented as a list of tuples, each of which represents a stack “frame”.  Each tuple is of the form:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="nv">Module</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">module</span><span class="p">(),</span><span class="w"> </span><span class="nv">Function</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">atom</span><span class="p">(),</span><span class="w"> </span><span class="nv">Arity</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="nv">AuxData</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">aux_data</span><span class="p">()}]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">aux_data()</span></code> is a (possibly empty) properties list containing the following elements:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="nv">File</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">string</span><span class="p">(),</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="nv">Line</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">pos_integer</span><span class="p">()}]</span>
</pre></div>
</div>
<p>Stack frames are ordered from the frame “closest“ to the point of failure (the “top” of the stack) to the frame furthest from the point of failure (the “bottom” of the stack).</p>
<p>Stack frames will contain file and line information in the AuxData list if the BEAM files (typically embedded in AVM files) include &lt;&lt;“Line”&gt;&gt; chunks generated by the compiler.  Otherwise, the AuxData will be an empty list.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Adding line information to BEAM files not only increases the size of BEAM files in storage, but calculation of file
and line information can have a non-negligible impact on memory usage.  Memory-sensitive applications should
consider not including line information in BEAM files.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">packbeam</span></code> tool does include file and line information in the AVM files it creates by default, but file and line information can be omitted via a command line option.  For information about the packbeam too, see the <a class="reference internal" href="atomvm-tooling.html#atomvm-packbeam"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm_packbeam</span></code> tool</span></a>.</p>
</section>
<section id="reading-data-from-avm-files">
<h3>Reading data from AVM files<a class="headerlink" href="#reading-data-from-avm-files" title="Link to this heading"></a></h3>
<p>AVM files are generally packed BEAM files, but they can also contain non-BEAM files, such as plain text files, binary data, or even encoded Erlang terms.</p>
<p>Typically, these files are included from the <code class="docutils literal notranslate"><span class="pre">priv</span></code> directory in a build tree, for example, when using the <a class="reference external" href="https://github.com/atomvm/atomvm_rebar3_plugin"><code class="docutils literal notranslate"><span class="pre">atomvm_rebar3_plugin</span></code></a>, though the <a class="reference external" href="https://github.com/atomvm/atomvm_packbeam"><code class="docutils literal notranslate"><span class="pre">atomvm_packbeam</span></code></a> tool allow you to specify any location for files to include in <a class="reference internal" href="packbeam-format.html"><span class="std std-doc">AVM files</span></a>.</p>
<p>By convention, these files obey the following path in an AVM file:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">&lt;application-name&gt;/priv/&lt;file-path&gt;</span></code></p>
</div></blockquote>
<p>For example, if you wanted to embed <code class="docutils literal notranslate"><span class="pre">my_file.txt</span></code> into your application AVM file (where your application name is, for example, <code class="docutils literal notranslate"><span class="pre">my_application</span></code>), you would use:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">my_application/priv/my_file.txt</span></code></p>
</div></blockquote>
<p>The <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#read-priv-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:read_priv/2</span></code></span></a> function can then be used to extract the contents of this file into a binary, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">MyFileBin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">read_priv</span><span class="p">(</span><span class="n">my_application</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;my_file.txt&quot;</span><span class="o">&gt;&gt;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Embedded files may contain path separators, so for example <code class="docutils literal notranslate"><span class="pre">&lt;&lt;&quot;my_files/my_file.txt&quot;&gt;&gt;</span></code> would be used if the AVM
file embeds <code class="docutils literal notranslate"><span class="pre">my_file.txt</span></code> using the path <code class="docutils literal notranslate"><span class="pre">my_application/priv/my_files/my_file.txt</span></code></p>
</div>
<p>For more information about how to embed files into <a class="reference internal" href="packbeam-format.html"><span class="std std-doc">AVM files</span></a>, see the <a class="reference external" href="https://github.com/atomvm/atomvm_rebar3_plugin"><code class="docutils literal notranslate"><span class="pre">atomvm_rebar3_plugin</span></code></a>, and the <a class="reference internal" href="atomvm-tooling.html#atomvm-rebar3-plugin"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm_rebar3_plugin</span></code></span></a> section of the <a class="reference internal" href="atomvm-tooling.html"><span class="std std-doc">AtomVM Tooling</span></a> guide.</p>
</section>
<section id="code-loading">
<h3>Code Loading<a class="headerlink" href="#code-loading" title="Link to this heading"></a></h3>
<p>AtomVM provides a limited set of APIs for loading code and data embedded dynamically at runtime.</p>
<p>To load an AVM file from binary data, use the <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#add-avm-pack-binary-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:add_avm_pack_binary/2</span></code></span></a> function.  Supply a reference to the AVM data, together with a (possibly empty) list of options.  Specify a <code class="docutils literal notranslate"><span class="pre">name</span></code> option, whose value is an atom, if you wish to close the AVM data at a later point in the program.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">AVMData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="c">%% load AVM data into memory as a binary</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">add_avm_pack_binary</span><span class="p">(</span><span class="nv">AVMData</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">my_avm</span><span class="p">}])</span>
</pre></div>
</div>
<p>You can also load AVM data from a file (on the <code class="docutils literal notranslate"><span class="pre">generic_unix</span></code> platform) or from a flash partition (on ESP32 platforms) using the <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#add-avm-pack-file-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:add_avm_pack_file/2</span></code></span></a> function.  Specify a string (or binary) as the path to the AVM file, together with a list of options, such as <code class="docutils literal notranslate"><span class="pre">name</span></code>.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">add_avm_pack_file</span><span class="p">(</span><span class="s">&quot;/path/to/file.avm&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">my_avm</span><span class="p">}])</span>
</pre></div>
</div>
<p>On <code class="docutils literal notranslate"><span class="pre">esp32</span></code> platforms, the partition name should be prefixed with the string <code class="docutils literal notranslate"><span class="pre">/dev/partition/by-name/</span></code>.  Thus, for example, if you specify <code class="docutils literal notranslate"><span class="pre">/dev/partition/by-name/main2.avm</span></code> as the partition, the ESP32 flash should contain a data partition with the name <code class="docutils literal notranslate"><span class="pre">main2.avm</span></code></p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">add_avm_pack_file</span><span class="p">(</span><span class="s">&quot;/dev/partition/by-name/main2.avm&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span>
</pre></div>
</div>
<p>To close a previous opened AVM by name, use the <a class="reference internal" href="apidocs/erlang/eavmlib/atomvm.html#close-avm-pack-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">atomvm:close_avm_pack/2</span></code></span></a> function.  Specify the name of the AVM pack used to add</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">atomvm</span><span class="p">:</span><span class="nf">close_avm_pack</span><span class="p">(</span><span class="n">my_avm</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Currently, the options parameter is ignored, so use the empty list (<code class="docutils literal notranslate"><span class="pre">[]</span></code>) for forward compatibility.</p>
</div>
<p>You can load an individual BEAM file using the <a class="reference internal" href="apidocs/erlang/estdlib/code.html#load-binary-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">code:load_binary/3</span></code></span></a> function.  Specify the Module name (as an atom), as well as the BEAM data you have loaded into memory.</p>
<p>For Example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">BEAMData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="c">%% load BEAM data into memory as a binary</span>
<span class="p">{</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="nv">Module</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">code</span><span class="p">:</span><span class="nf">load_binary</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span><span class="w"> </span><span class="nv">Filename</span><span class="p">,</span><span class="w"> </span><span class="nv">BEAMData</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Filename</span></code> parameter is currently ignored.</p>
</div>
<p>You can load an individual BEAM file from the file system using the <a class="reference internal" href="apidocs/erlang/estdlib/code.html#load-abs-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">code:load_abs/1</span></code></span></a> function.  Specify the path to the BEAM file.  This path should not include the <code class="docutils literal notranslate"><span class="pre">.beam</span></code> extension, as this extension will be added automatically.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="nv">Module</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">code</span><span class="p">:</span><span class="nf">load_abs</span><span class="p">(</span><span class="s">&quot;/path/to/beam/file/without/beam/extension&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This function is currently only supported on the <code class="docutils literal notranslate"><span class="pre">generic_unix</span></code> platform.</p>
</div>
</section>
<section id="math">
<h3>Math<a class="headerlink" href="#math" title="Link to this heading"></a></h3>
<p>AtomVM supports the following standard functions from the OTP <a class="reference internal" href="apidocs/erlang/estdlib/math.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">math</span></code> module</span></a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cos/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acos/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acosh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">asin/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">asinh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">atan/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">atan2/2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">atanh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ceil/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cosh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exp/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">floor/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fmod/2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log10/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log2/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pow/2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sin/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sinh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sqrt/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tan/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tanh/1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pi/0</span></code></p></li>
</ul>
<p>The input values for these functions may be <code class="docutils literal notranslate"><span class="pre">float</span></code> or <code class="docutils literal notranslate"><span class="pre">integer</span></code> types.  The return value is always a value of <code class="docutils literal notranslate"><span class="pre">float</span></code> type.</p>
<p>Input values that are out of range for the specific mathematical function or which otherwise are invalid or yield an invalid result (e.g., division by 0) will result in a <code class="docutils literal notranslate"><span class="pre">badarith</span></code> error.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If the AtomVM virtual machine is built with floating point arithmetic support disabled, these functions will result
in a <code class="docutils literal notranslate"><span class="pre">badarg</span></code> error.</p>
</div>
</section>
<section id="cryptographic-operations">
<h3>Cryptographic Operations<a class="headerlink" href="#cryptographic-operations" title="Link to this heading"></a></h3>
<p>You can hash binary date using the <a class="reference internal" href="apidocs/erlang/estdlib/crypto.html#hash-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">crypto:hash/2</span></code></span></a> function.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">crypto</span><span class="p">:</span><span class="nb">hash</span><span class="p">(</span><span class="n">sha</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;Some binary&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="sc">$\s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;data&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>This function takes a hash algorithm, which may be one of:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">md_type</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nb">md5</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">sha</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">sha224</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">sha256</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">sha384</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">sha512</span><span class="p">.</span>
</pre></div>
</div>
<p>and an IO list.  The output type is a binary, who’s length (in bytes) is dependent on the algorithm chosen:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Algorithm</p></th>
<th class="head"><p>Hash Length (bytes)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">md5</span></code></p></td>
<td><p>16</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sha</span></code></p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sha224</span></code></p></td>
<td><p>32</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sha256</span></code></p></td>
<td><p>32</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sha384</span></code></p></td>
<td><p>64</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sha512</span></code></p></td>
<td><p>64</p></td>
</tr>
</tbody>
</table>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The <code class="docutils literal notranslate"><span class="pre">crypto:hash/2</span></code> function is currently only supported on the ESP32 and generic UNIX platforms.</p>
</div>
<p>You can also use the legacy <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#md5-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:md5/1</span></code></span></a> function to compute the MD5 hash of an input binary.  The output is a fixed-length binary (16 bytes)</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nb">md5</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="n">foo</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</pre></div>
</div>
<p>On ESP32, you can perform symmetric encryption and decryption of any iodata data using <a class="reference internal" href="apidocs/erlang/estdlib/crypto.html#function-index"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">crypto_one_time/4,5</span></code></span></a> function.</p>
<p>Following ciphers are supported:</p>
<p>Without IV (using <a class="reference internal" href="apidocs/erlang/estdlib/crypto.html#crypto-one-time-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">crypto_one_time/4</span></code></span></a>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aes_128_ecb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_192_ecb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_256_ecb</span></code></p></li>
</ul>
<p>With IV (using <a class="reference internal" href="apidocs/erlang/estdlib/crypto.html#crypto-one-time-5"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">crypto_one_time/5</span></code></span></a>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aes_128_cbc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_192_cbc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_256_cbc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_128_cfb128</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_192_cfb128</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_256_cfb128</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_128_ctr</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_192_ctr</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_256_ctr</span></code></p></li>
</ul>
<p>The function is implemented using <a class="reference external" href="https://github.com/Mbed-TLS/mbedtls">mbedTLS</a>, so please to its
documentation for further details.</p>
<p>Please refer to
<a class="reference external" href="https://www.erlang.org/doc/man/crypto#crypto_one_time4">Erlang crypto documentation</a> for
additional details about these two functions.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note: mbedTLS doesn’t support padding for ciphers other than CCB, so block size must be accounted otherwise output
will be truncated.</p>
</div>
</section>
</section>
<section id="esp32-specific-apis">
<h2>ESP32-specific APIs<a class="headerlink" href="#esp32-specific-apis" title="Link to this heading"></a></h2>
<p>Certain APIs are specific to and only supported on the ESP32 platform.  This section describes these APIs.</p>
<section id="system-level-apis">
<h3>System-Level APIs<a class="headerlink" href="#system-level-apis" title="Link to this heading"></a></h3>
<p>As noted above, the <a class="reference internal" href="apidocs/erlang/estdlib/erlang.html#system-info-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">erlang:system_info/1</span></code></span></a> function can be used to obtain system-specific information about the platform on which your application is deployed.</p>
<p>You can request ESP32-specific information using using the following input atoms:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">esp32_free_heap_size</span></code> Returns the available free space in the ESP32 heap.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp32_largest_free_block</span></code> Returns the size of the largest free continuous block in the ESP32 heap.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp32_minimum_free_size</span></code> Returns the smallest ever free space available in the ESP32 heap since boot, this will tell you how close you have come to running out of free memory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp32_chip_info</span></code> Returns map of the form <code class="docutils literal notranslate"><span class="pre">#{features</span> <span class="pre">:=</span> <span class="pre">Features,</span> <span class="pre">cores</span> <span class="pre">:=</span> <span class="pre">Cores,</span> <span class="pre">revision</span> <span class="pre">:=</span> <span class="pre">Revision,</span> <span class="pre">model</span> <span class="pre">:=</span> <span class="pre">Model}</span></code>, where <code class="docutils literal notranslate"><span class="pre">Features</span></code> is a list of features enabled in the chip, from among the following atoms: <code class="docutils literal notranslate"><span class="pre">[emb_flash,</span> <span class="pre">bgn,</span> <span class="pre">ble,</span> <span class="pre">bt]</span></code>; <code class="docutils literal notranslate"><span class="pre">Cores</span></code> is the number of CPU cores on the chip; <code class="docutils literal notranslate"><span class="pre">Revision</span></code> is the chip version; and <code class="docutils literal notranslate"><span class="pre">Model</span></code> is one of the following atoms: <code class="docutils literal notranslate"><span class="pre">esp32</span></code>, <code class="docutils literal notranslate"><span class="pre">esp32_s2</span></code>, <code class="docutils literal notranslate"><span class="pre">esp32_s3</span></code>, <code class="docutils literal notranslate"><span class="pre">esp32_c3</span></code>, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_idf_version</span></code> Return the IDF SDK version, as a string.</p></li>
</ul>
<p>For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">FreeHeapSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">esp32_free_heap_size</span><span class="p">).</span>
</pre></div>
</div>
</section>
<section id="non-volatile-storage">
<h3>Non-volatile Storage<a class="headerlink" href="#non-volatile-storage" title="Link to this heading"></a></h3>
<p>AtomVM provides functions for setting, retrieving, and deleting key-value data in binary form in non-volatile storage (NVS) on an ESP device.  Entries in NVS survive reboots of the ESP device, and can be used a limited “persistent store” for key-value data.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>NVS storage is limited in size, and NVS keys are restricted to 15 characters.  Try to avoid writing frequently to NVS
storage, as the flash storage may degrade more rapidly with repeated writes to the medium.</p>
</div>
<p>NVS entries are stored under a namespace and key, both of which are expressed as atoms.  AtomVM uses the namespace <code class="docutils literal notranslate"><span class="pre">atomvm</span></code> for entries under its control.  Applications may read from and write to the <code class="docutils literal notranslate"><span class="pre">atomvm</span></code> namespace, but they are strongly discouraged from doing so, except when explicitly stated otherwise.</p>
<p>To set a value in non-volatile storage, use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#nvs-set-binary-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:nvs_set_binary/3</span></code></span></a> function, and specify a namespace, key, and value:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;my-namespace&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="nv">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;my-key&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="nn">esp</span><span class="p">:</span><span class="nf">set_binary</span><span class="p">(</span><span class="nv">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nv">Key</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;some-value&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</pre></div>
</div>
<p>To retrieve a value in non-volatile storage, use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#nvs-get-binary-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:nvs_get_binary/2</span></code></span></a> function, and specify a namespace and key.  You can optionally specify a default value (of any desired type), if an entry does not exist in non-volatile storage:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">get_binary</span><span class="p">(</span><span class="nv">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nv">Key</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;default-value&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</pre></div>
</div>
<p>To delete an entry, use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#nvs-erase-key-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:nvs_erase_key/2</span></code></span></a> function, and specify a namespace and key:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">erase_key</span><span class="p">(</span><span class="nv">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
<p>You can delete all entries in a namespace via the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#nvs-erase-all-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:nvs_erase_all/1</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">erase_all</span><span class="p">(</span><span class="nv">Namespace</span><span class="p">).</span>
</pre></div>
</div>
<p>Finally, you can delete all entries in all namespaces on the NVS partition via the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#nvs-reformat-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:nvs_reformat/0</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">reformat</span><span class="p">().</span>
</pre></div>
</div>
<p>Applications should use the <code class="docutils literal notranslate"><span class="pre">esp:nvs_reformat/0</span></code> function with caution, in case other applications are making using the non-volatile storage.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>NVS entries are currently stored in plaintext and are not encrypted.  Applications should exercise caution if
sensitive security information, such as account passwords, are stored in NVS storage.</p>
</div>
</section>
<section id="storage">
<h3>Storage<a class="headerlink" href="#storage" title="Link to this heading"></a></h3>
<p>AtomVM provides support for mounting and unmounting storage on ESP32 devices, such as SD cards or internal flash memory. This functionality is accessible through the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#mount-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:mount/4</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#umount-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:umount/1</span></code></span></a> functions.</p>
<section id="mounting-mmc-sd-card">
<h4>Mounting MMC SD card<a class="headerlink" href="#mounting-mmc-sd-card" title="Link to this heading"></a></h4>
<p>To mount a MMC SD card, use the <code class="docutils literal notranslate"><span class="pre">esp:mount/4</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">mount</span><span class="p">(</span><span class="s">&quot;sdmmc&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/sdcard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fat</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;SD card mounted successfully</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">};</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Failed to mount SD card: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">]),</span>
<span class="w">        </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</section>
<section id="mounting-spi-sd-card">
<h4>Mounting SPI SD card<a class="headerlink" href="#mounting-spi-sd-card" title="Link to this heading"></a></h4>
<p>To mount a SPI SD card, first create a SPI instance configured for your specific board, then use the <code class="docutils literal notranslate"><span class="pre">esp:mount/4</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">SPIConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="n">bus_config</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="n">miso</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="n">mosi</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="n">sclk</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="n">peripheral</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;spi3&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">]}],</span>
<span class="nv">SPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">SPIConfig</span><span class="p">),</span>
<span class="k">case</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">mount</span><span class="p">(</span><span class="s">&quot;sdspi&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/sdcard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fat</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">spi_host</span><span class="p">,</span><span class="w"> </span><span class="nv">SPI</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">}])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;SD card mounted successfully</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">};</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Failed to mount SD card: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">]),</span>
<span class="w">        </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</section>
<section id="mounting-internal-flash">
<h4>Mounting internal flash<a class="headerlink" href="#mounting-internal-flash" title="Link to this heading"></a></h4>
<p>To mount internal flash, use the <code class="docutils literal notranslate"><span class="pre">esp:mount/4</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">mount</span><span class="p">(</span><span class="s">&quot;/dev/partition/by-name/partition_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/test&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fat</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Flash mounted successfully</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">MountedRef</span><span class="p">};</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Failed to mount partition: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">]),</span>
<span class="w">        </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</section>
<section id="unmounting-storage">
<h4>Unmounting Storage<a class="headerlink" href="#unmounting-storage" title="Link to this heading"></a></h4>
<p>To unmount a previously mounted storage device, use the <code class="docutils literal notranslate"><span class="pre">esp:umount/1</span></code> function, with the reference returned from <code class="docutils literal notranslate"><span class="pre">esp:mount/4</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">umount</span><span class="p">(</span><span class="nv">MountedRef</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Storage unmounted successfully</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Failed to unmount storage: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>These functions allow you to work with external storage devices or partitions on your ESP32, enabling you to read from and write to files on the mounted filesystem. This can be particularly useful for applications that need to store or access large amounts of data that don’t fit in the device’s main memory or non-volatile storage.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember to properly unmount any mounted filesystems before powering off or resetting the device to prevent data corruption.</p>
</div>
</section>
</section>
<section id="restart-and-deep-sleep">
<h3>Restart and Deep Sleep<a class="headerlink" href="#restart-and-deep-sleep" title="Link to this heading"></a></h3>
<p>You can use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#restart-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:restart/0</span></code></span></a> function to immediately restart the ESP32 device.  This function does not return a value.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">esp</span><span class="p">:</span><span class="nf">restart</span><span class="p">().</span>
</pre></div>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#reset-reason-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:reset_reason/0</span></code></span></a> function to obtain the reason for the ESP32 restart.  Possible values include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_unknown</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_poweron</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_ext</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_sw</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_panic</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_int_wdt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_task_wdt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_wdt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_deepsleep</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_brownout</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rst_sdio</span></code></p></li>
</ul>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#deep-sleep-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:deep_sleep/1</span></code></span></a> function to put the ESP device into deep sleep for a specified number of milliseconds.  Be sure to safely stop any critical processes running before this function is called, as it will cause an immediate shutdown of the device.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">esp</span><span class="p">:</span><span class="nf">deep_sleep</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span>
</pre></div>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#sleep-get-wakeup-cause-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:sleep_get_wakeup_cause/0</span></code></span></a> function to inspect the reason for a wakeup.  Possible return values include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_ext0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_ext1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_timer</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_touchpad</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_ulp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_gpio</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_uart</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_wifi</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_cocpu</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_cocpu_trag_trig</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sleep_wakeup_bt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">undefined</span></code> (no sleep wakeup)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code> (unknown other reason)</p></li>
</ul>
<p>The values matches the semantics of <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/release-v4.4/esp32/api-reference/system/sleep_modes.html#_CPPv426esp_sleep_get_wakeup_causev"><code class="docutils literal notranslate"><span class="pre">esp_sleep_get_wakeup_cause</span></code></a>.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">sleep_get_wakeup_cause</span><span class="p">()</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">sleep_wakeup_timer</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Woke up from a timer</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep_wakeup_ext0</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Woke up from ext0</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep_wakeup_ext1</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Woke up from ext1</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Woke up for some other reason</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#sleep-enable-ext0-wakeup-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:sleep_enable_ext0_wakeup/2</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#sleep-enable-ext1-wakeup-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:sleep_enable_ext1_wakeup/2</span></code></span></a> functions to configure ext0 and ext1 wakeup mechanisms. They follow the semantics of <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/release-v4.4/esp32/api-reference/system/sleep_modes.html#_CPPv428esp_sleep_enable_ext0_wakeup10gpio_num_ti"><code class="docutils literal notranslate"><span class="pre">esp_sleep_enable_ext0_wakeup</span></code></a> and <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/release-v4.4/esp32/api-reference/system/sleep_modes.html#_CPPv428esp_sleep_enable_ext1_wakeup8uint64_t28esp_sleep_ext1_wakeup_mode_t"><code class="docutils literal notranslate"><span class="pre">esp_sleep_enable_ext1_wakeup</span></code></a>.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">spec</span><span class="w"> </span><span class="n">shutdown</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">no_return</span><span class="p">().</span>
<span class="nf">shutdown</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c">% Configure wake up when GPIO 37 is set to low (M5StickC main button)</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">sleep_enable_ext0_wakeup</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="c">% Deep sleep for 1 hour</span>
<span class="w">    </span><span class="nn">esp</span><span class="p">:</span><span class="nf">deep_sleep</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span>
</pre></div>
</div>
<section id="rtc-memory">
<h4>RTC Memory<a class="headerlink" href="#rtc-memory" title="Link to this heading"></a></h4>
<p>On ESP32 systems, you can use (slow) “real-time clock” memory to store data between deep sleeps.  This storage can be useful, for example, to store interim state data in your application.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>RTC memory is initialized if power is lost.</p>
</div>
<p>To store data in RTC slow memory, use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#rtc-slow-set-binary-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:rtc_slow_set_binary/1</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">esp</span><span class="p">:</span><span class="nf">rtc_slow_set_binary</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;some binary data&quot;</span><span class="o">&gt;&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>To retrieve data in RTC slow memory, use the <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#rtc-slow-get-binary-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:rtc_slow_get_binary/0</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">rtc_slow_get_binary</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Calling <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#rtc-slow-get-binary-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:rtc_slow_get_binary/0</span></code></span></a> without having stored a binary first using <a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#rtc-slow-set-binary-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:rtc_slow_set_binary/1</span></code></span></a>, will raise with badarg. So make sure to wrap such a call with a try/catch or similar.</p>
</div>
<p>By default, RTC slow memory in AtomVM is limited to 4098 (4k) bytes.  This value can be modified at build time using an IDF SDK <code class="docutils literal notranslate"><span class="pre">KConfig</span></code> setting.  For  instructions about how to build AtomVM, see the AtomVM <a class="reference internal" href="build-instructions.html#building-for-esp32"><span class="std std-ref">Build Instructions</span></a>.</p>
</section>
</section>
<section id="miscellaneous-esp32-apis">
<h3>Miscellaneous ESP32 APIs<a class="headerlink" href="#miscellaneous-esp32-apis" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#freq-hz-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:freq_hz/0</span></code></span></a>
The <code class="docutils literal notranslate"><span class="pre">esp:freq_hz/0</span></code> function can be used to retrieve the clock frequency of the chip.</p></li>
<li><p><a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#partition-list-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:partition_list/0</span></code></span></a>
The <code class="docutils literal notranslate"><span class="pre">esp:partition_list/0</span></code> function can be used to retrieve information about the partitions on an ESP32 flash.</p></li>
</ul>
<blockquote>
<div><p>The return type is a list of tuples, each of which contains the partition id (as a binary), partition type and sub-type (both of which are represented as integers), the start of the partition as an address along with its size, as well as a list of properties about the partition, as a properties list.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">PartitionList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">partition_list</span><span class="p">(),</span>
<span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span>
<span class="w">   </span><span class="k">fun</span><span class="p">({</span>
<span class="w">       </span><span class="nv">PartitionId</span><span class="p">,</span><span class="w"> </span><span class="nv">PartitionType</span><span class="p">,</span><span class="w"> </span><span class="nv">PartitionSubtype</span><span class="p">,</span><span class="w"> </span><span class="nv">PartitionAddress</span><span class="p">,</span><span class="w"> </span><span class="nv">PartitionSize</span><span class="p">,</span>
<span class="w">       </span><span class="nv">PartitionProperties</span>
<span class="w">       </span><span class="p">})</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">           </span><span class="c">%% ...</span>
<span class="w">       </span><span class="k">end</span><span class="p">,</span>
<span class="w">       </span><span class="nv">PartitionList</span>
<span class="w">   </span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The partition properties are currently empty (<code class="docutils literal notranslate"><span class="pre">[]</span></code>).</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For information about the encoding of partition types and sub-types, see the IDF SDK partition
<a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/v4.4.5/esp32/api-reference/storage/spi_flash.html?highlight=esp_partition_get#id13">type definitions</a>.</p>
</div>
</div></blockquote>
<ul class="simple">
<li><p><a class="reference internal" href="apidocs/erlang/eavmlib/esp.html#get-mac-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">esp:get_mac/1</span></code></span></a>
The <code class="docutils literal notranslate"><span class="pre">esp:get_mac/1</span></code> function can be used to retrieve the network Media Access Control (<a class="reference external" href="https://en.wikipedia.org/wiki/MAC_address">MAC</a>) address for a given interface, <a class="reference internal" href="network-programming-guide.html#station-sta-mode"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">wifi_sta</span></code></span></a> or <a class="reference internal" href="network-programming-guide.html#ap-mode"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">wifi_softap</span></code></span></a>.  The return value is a 6-byte binary, in accordance with the <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_802">IEEE 802</a> family of specifications.</p></li>
</ul>
<blockquote>
<div><div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">MacAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp</span><span class="p">:</span><span class="nf">get_mac</span><span class="p">(</span><span class="n">wifi_sta</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="peripherals">
<h2>Peripherals<a class="headerlink" href="#peripherals" title="Link to this heading"></a></h2>
<p>The AtomVM virtual machine and libraries support APIs for interfacing with peripheral devices connected to the ESP32 and other supported microcontrollers.  This section provides information about these APIs.  Unless otherwise stated the documentation for these peripherals is specific to the ESP32, most peripherals are not yet supported on rp2040 or stm32 devices - but work is on-going to expand support for these platforms.</p>
<section id="gpio">
<h3>GPIO<a class="headerlink" href="#gpio" title="Link to this heading"></a></h3>
<p>The GPIO peripheral has nif support on all platforms. One notable difference on the STM32 platform is that <code class="docutils literal notranslate"><span class="pre">Pin()</span></code> is defined as a tuple consisting of the bank (a.k.a. port) and pin number.  For example a pin labeled PB7 on your board would be <code class="docutils literal notranslate"><span class="pre">{b,7}</span></code>.</p>
<p>You can read and write digital values on GPIO pins using the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gpio</span></code> module</span></a>, using the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#digital-read-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">digital_read/1</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#digital-write-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">digital_write/2</span></code></span></a> functions.  You must first set the pin mode using the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#set-pin-mode-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:set_pin_mode/2</span></code></span></a> function, using <code class="docutils literal notranslate"><span class="pre">input</span></code> or <code class="docutils literal notranslate"><span class="pre">output</span></code> as the direction parameter.</p>
<section id="digital-read">
<h4>Digital Read<a class="headerlink" href="#digital-read" title="Link to this heading"></a></h4>
<p>To read the value of a GPIO pin (<code class="docutils literal notranslate"><span class="pre">high</span></code> or <code class="docutils literal notranslate"><span class="pre">low</span></code>), use <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#digital-read-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:digital_read/1</span></code></span></a>.</p>
<p>For ESP32 family:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_read</span><span class="p">(</span><span class="nv">Pin</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">high</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is high </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">]);</span>
<span class="w">    </span><span class="n">low</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is low </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>For STM32 only the line with the Pin definition needs to be a tuple:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">},</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_read</span><span class="p">(</span><span class="nv">Pin</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">high</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is high </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">]);</span>
<span class="w">    </span><span class="n">low</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is low </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>The Pico has an additional initialization step <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#init-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:init/1</span></code></span></a> before using a pin for gpio:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">init</span><span class="p">(</span><span class="nv">Pin</span><span class="p">),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_read</span><span class="p">(</span><span class="nv">Pin</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">high</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is high </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">]);</span>
<span class="w">    </span><span class="n">low</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is low </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</section>
<section id="digital-write">
<h4>Digital Write<a class="headerlink" href="#digital-write" title="Link to this heading"></a></h4>
<p>To set the value of a GPIO pin (<code class="docutils literal notranslate"><span class="pre">high</span></code> or <code class="docutils literal notranslate"><span class="pre">low</span></code>), use <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#digital-write-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:digital_write/2</span></code></span></a>.</p>
<p>For ESP32 family:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_write</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="p">).</span>
</pre></div>
</div>
<p>For the STM32 use a pin tuple:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">},</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_write</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="p">).</span>
</pre></div>
</div>
<p>Pico needs the extra <code class="docutils literal notranslate"><span class="pre">gpio:init/1</span></code> before <code class="docutils literal notranslate"><span class="pre">gpio:read/1</span></code> too:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">init</span><span class="p">(</span><span class="nv">Pin</span><span class="p">),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_pin_mode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">digital_write</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="p">).</span>
</pre></div>
</div>
</section>
<section id="interrupt-handling">
<h4>Interrupt Handling<a class="headerlink" href="#interrupt-handling" title="Link to this heading"></a></h4>
<p>Interrupts are supported on both the ESP32 and STM32 platforms. They require using the GPIO port driver, using <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#open-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:open/0</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#set-direction-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:set_direction/3</span></code></span></a>.</p>
<p>You can get notified of changes in the state of a GPIO pin by using the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#set-int-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:set_int/3</span></code></span></a> function.  This function takes a reference to a GPIO instance, a Pin, and a trigger.  Allowable triggers are <code class="docutils literal notranslate"><span class="pre">rising</span></code>, <code class="docutils literal notranslate"><span class="pre">falling</span></code>, <code class="docutils literal notranslate"><span class="pre">both</span></code>, <code class="docutils literal notranslate"><span class="pre">low</span></code>, <code class="docutils literal notranslate"><span class="pre">high</span></code>, and <code class="docutils literal notranslate"><span class="pre">none</span></code> (to disable an interrupt).</p>
<p>When a trigger event occurs, such as a pin rising in voltage, a tuple will be delivered to the process that set the interrupt containing the atom <code class="docutils literal notranslate"><span class="pre">gpio_interrupt</span></code> and the pin.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nv">GPIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">open</span><span class="p">(),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_direction</span><span class="p">(</span><span class="nv">GPIO</span><span class="p">,</span><span class="w"> </span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">set_int</span><span class="p">(</span><span class="nv">GPIO</span><span class="p">,</span><span class="w"> </span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">rising</span><span class="p">),</span>
<span class="k">receive</span>
<span class="w">    </span><span class="p">{</span><span class="n">gpio_interrupt</span><span class="p">,</span><span class="w"> </span><span class="nv">Pin</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Pin </span><span class="si">~p</span><span class="s"> is rising </span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>You can also use the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#set-int-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:set_int/4</span></code></span></a> function, and specify a listener <code class="docutils literal notranslate"><span class="pre">pid()</span></code> or registered name as the recipient of interrupt messages as the fourth parameter.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="nv">GPIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">open</span><span class="p">(),</span>
<span class="nn">gpio</span><span class="p">:</span><span class="nf">set_direction</span><span class="p">(</span><span class="nv">GPIO</span><span class="p">,</span><span class="w"> </span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span>
<span class="nv">Listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">my_gen_statem</span><span class="p">()</span><span class="w"> </span><span class="k">end</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">set_int</span><span class="p">(</span><span class="nv">GPIO</span><span class="p">,</span><span class="w"> </span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">rising</span><span class="p">,</span><span class="w"> </span><span class="nv">Listener</span><span class="p">),</span>
<span class="nn">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p">(</span><span class="n">infinity</span><span class="p">).</span>
</pre></div>
</div>
<p>Interrupts can be removed by using the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#remove-int-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:remove_int/2</span></code></span></a> function.</p>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#close-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:close/1</span></code></span></a> function to close the GPIO driver and free any resources in use by it, supplying a reference to a previously opened GPIO driver instance.  Any references to the closed GPIO instance are no longer valid after a successful call to this function, and all interrupts will be removed.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">GPIO</span><span class="p">).</span>
</pre></div>
</div>
<p>Since only one instance of the GPIO driver is allowed, you may also simply use <a class="reference internal" href="apidocs/erlang/eavmlib/gpio.html#stop-0"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gpio:stop/0</span></code></span></a> to remove all interrupts, free the resources, and close the GPIO driver port.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">gpio</span><span class="p">:</span><span class="nf">stop</span><span class="p">().</span>
</pre></div>
</div>
</section>
</section>
<section id="esp32-adc">
<h3>ESP32 ADC<a class="headerlink" href="#esp32-adc" title="Link to this heading"></a></h3>
<p>The <a class="reference internal" href="apidocs/erlang/eavmlib/esp_adc.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">esp_adc</span></code> module</span></a> provides the functionality to use the ESP32 family <a class="reference external" href="https://en.wikipedia.org/wiki/Successive-approximation_ADC">SAR ADC</a> peripheral to measure (analog) voltages from a pin and obtain both raw bit values as well as calibrated voltage values in millivolts.</p>
<p>The module provides two sets of APIs for using the ADC peripheral; there is a set of low level resource based nifs, and a gen_server managed set of convenience functions. The nifs rely on unit and channel handle resources for configuring and taking measurements. The convenience functions use the gen_server to maintain these resources and use pin numbers to interact with the driver. Examples for both APIs can be found the <a class="reference external" href="https://github.com/atomvm/AtomVM/tree/main/examples/erlang/esp32">AtomVM repository atomvm/examples/erlang/esp32</a> directory. A demonstration of the simple APIs is as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="w">    </span><span class="nv">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp_adc</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">bitwidth</span><span class="p">,</span><span class="w"> </span><span class="n">bit_12</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">atten</span><span class="p">,</span><span class="w"> </span><span class="n">db_2_5</span><span class="p">}]),</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">Raw</span><span class="p">,</span><span class="w"> </span><span class="nv">Mv</span><span class="p">}}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp_adc</span><span class="p">:</span><span class="nf">read</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">raw</span><span class="p">,</span><span class="w"> </span><span class="n">voltage</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">}]),</span>
<span class="w">    </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;ADC pin </span><span class="si">~p</span><span class="s"> raw value=</span><span class="si">~p</span><span class="s"> millivolts=</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Pin</span><span class="p">,</span><span class="w"> </span><span class="nv">Raw</span><span class="p">,</span><span class="w"> </span><span class="nv">Mv</span><span class="p">]),</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">esp_adc</span><span class="p">:</span><span class="nf">stop</span><span class="p">(),</span>
<span class="p">...</span>
</pre></div>
</div>
<section id="esp32-adc-configuration-options">
<h4>ESP32 ADC configuration options<a class="headerlink" href="#esp32-adc-configuration-options" title="Link to this heading"></a></h4>
<p>Some newer ESP32 family devices only use a single fixed bit width, this is typically 12 bits, but some provide 13 bit resolution. The ESP32 classic supports 9 bit up to 12 bit resolutions. The <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> option <code class="docutils literal notranslate"><span class="pre">bit_max</span></code> will use the highest supported resolution for the device.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">attenuation</span></code> option determines the range of voltage to be measured, the specific voltage range for each setting varies by chip, so as always consult your devices datasheet before connecting an ADC pin to a voltage supply to be measured. The chart below depicts the approximate safe voltage ranges for each attenuation level:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Attenuation</p></th>
<th class="head"><p>Min Millivolts</p></th>
<th class="head"><p>Max Millivolts</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">db_0</span></code></p></td>
<td><p>0-100</p></td>
<td><p>750-950</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">db_2_5</span></code></p></td>
<td><p>0-100</p></td>
<td><p>1050-1250</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">db_6</span></code></p></td>
<td><p>0-150</p></td>
<td><p>1300-1750</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">db_11</span> <span class="pre">|</span> <span class="pre">db_12</span></code></p></td>
<td><p>0-150</p></td>
<td><p>2450-2500</p></td>
</tr>
</tbody>
</table>
<p>Consult the datasheet of your device for the exact voltage ranges supported by each attenuation level.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The option <code class="docutils literal notranslate"><span class="pre">db_11</span></code> has been superseded by <code class="docutils literal notranslate"><span class="pre">db_12</span></code>. The option <code class="docutils literal notranslate"><span class="pre">db_11</span></code> and will be deprecated in a future release, applications should be updated to use <code class="docutils literal notranslate"><span class="pre">db_12</span></code> (except for builds with ESP-IDF versions prior to v5.2). To Continue to support older IDF version builds, the default will remain <code class="docutils literal notranslate"><span class="pre">db_11</span></code>, which is the maximum tolerated voltage on all builds, as <code class="docutils literal notranslate"><span class="pre">db_12</span></code> supported builds will automatically use <code class="docutils literal notranslate"><span class="pre">db_12</span></code> in place of <code class="docutils literal notranslate"><span class="pre">db_11</span></code>. After <code class="docutils literal notranslate"><span class="pre">db_11</span></code> is deprecated in all builds (with the sunset of ESP-IDF v5.1 support) the default will be changed to <code class="docutils literal notranslate"><span class="pre">db_12</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a higher degree of accuracy increase the number of sample taken, the default is 64. If highly stable and accurate ADC measurements are required for an application you may need to connect a bypass capacitor (e.g., a 100 nF ceramic capacitor) to the ADC input pad in use, to minimize noise. This chart from the <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/v5.3/esp32/api-reference/peripherals/adc_calibration.html">Espressif ADC Calibration Driver documentation</a> shows the difference between the use of a capacitor and without, as well as with a capacitor and multisampling of 64 samples.</p>
<p><img alt="ADC Noise Comparison" src="https://docs.espressif.com/projects/esp-idf/en/v5.3/esp32/_images/adc-noise-graph.jpg" /></p>
<p>You can clearly see the noisy results without a capacitor. This is mitigated by the use of multisampling but without a decoupling capacitor results will likely still contain some noise.</p>
</div>
<p>When an ADC channel is configured by the use of <code class="docutils literal notranslate"><span class="pre">esp_adc:acquire/2,4</span></code> or <code class="docutils literal notranslate"><span class="pre">esp_adc:start/1,2</span></code> the driver will select the optimal calibration mechanism supported by the device and channel configuration. If neither the line fitting or curve fitting mechanisms are supported by the device using the provided configuration options an estimated result will be used to provide <code class="docutils literal notranslate"><span class="pre">voltage</span></code> values, based on the <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/v5.3/esp32/api-reference/peripherals/adc_oneshot.html#read-conversion-result">formula suggested by Espressif</a>. For chips using the line fitting calibration scheme that do not have the default vref efuse set, a default vref of 1100 mV is used, this is not currently settable.</p>
</section>
<section id="esp32-adc-read-options">
<h4>ESP32 ADC read options<a class="headerlink" href="#esp32-adc-read-options" title="Link to this heading"></a></h4>
<p>The read options take the form of a proplist, if the key <code class="docutils literal notranslate"><span class="pre">raw</span></code> is true (<code class="docutils literal notranslate"><span class="pre">{raw,</span> <span class="pre">true}</span></code> or simply appears in the list as the atom <code class="docutils literal notranslate"><span class="pre">raw</span></code>), then the raw value will be returned in the first element of the returned tuple.  Otherwise, this element will be the atom <code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
<p>If the key <code class="docutils literal notranslate"><span class="pre">voltage</span></code> is true (or simply appears in the list as an atom), then a calibrated voltage value will be returned in millivolts in the second element of the returned tuple.  Otherwise, this element will be the atom <code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
<p>You may specify the number of samples (1 - 100000) to be taken and averaged over using the tuple <code class="docutils literal notranslate"><span class="pre">{samples,</span> <span class="pre">Samples</span> <span class="pre">::</span> <span class="pre">1..100000}</span></code>, the default is <code class="docutils literal notranslate"><span class="pre">64</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using a large number of samples can significantly increase the amount of time before a response, up to several seconds.</p>
</div>
</section>
</section>
<section id="i2c">
<h3>I2C<a class="headerlink" href="#i2c" title="Link to this heading"></a></h3>
<p>The <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">i2c</span></code> module</span></a> encapsulates functionality associated with the 2-wire Inter-Integrated Circuit (I2C) interface.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Information about the ESP32 I2C interface can be found in the IDF SDK <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2c.html">I2C Documentation</a>.</p>
</div>
<p>The AtomVM I2C implementation uses the AtomVM Port mechanism and must be initialized using the <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#open-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:open/1</span></code></span></a> function.  The single parameter contains a properties list, with the following elements:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">scl</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>I2C clock pin (SCL)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sda</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>I2C data pin (SDA)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clock_speed_hz</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>I2C clock frequency (in hertz)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">peripheral</span></code></p></td>
<td><p>`string()</p></td>
<td><p>binary()`</p></td>
<td><p>no (platform dependent default)</p></td>
</tr>
</tbody>
</table>
<p>For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">I2C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">open</span><span class="p">([{</span><span class="n">scl</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">sda</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">clock_speed_hz</span><span class="p">,</span><span class="w"> </span><span class="mi">40000</span><span class="p">}]),</span>
</pre></div>
</div>
<p>Once the port is opened, you can use the returned <code class="docutils literal notranslate"><span class="pre">I2C</span></code> instance to read and write bytes to the attached device.</p>
<p>Both read and write operations require the I2C bus address from which data is read or to which data is written.  A devices address is typically hard-wired for the specific device type, or in some cases may be changed by the addition or removal of a resistor.</p>
<p>In addition, you may optionally specify a register to read from or write to, as some devices require specification of a register value.  Consult your device’s data sheet for more information and the device’s I2C bus address and registers, if applicable.</p>
<p>There are two patterns for writing data to an I2C device:</p>
<ol class="arabic simple">
<li><p>Queuing <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#write-bytes-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:write_bytes/2,3,4</span></code></span></a> write operations between calls to <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#begin-transmission-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:begin_transmission/2</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#end-transmission-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:end_transmission/1</span></code></span></a>.  In this case, write operations are queued locally and dispatched to the target device when the <code class="docutils literal notranslate"><span class="pre">i2c:end_transmission/1</span></code> operation is called;</p></li>
<li><p>Writing a byte or sequence of bytes in one <code class="docutils literal notranslate"><span class="pre">i2c:write_bytes/2,3,4</span></code> operation.</p></li>
</ol>
<p>The choice of which pattern to use will depend on the device being communicated with.  For example, some devices require a sequence of write operations to be queued and written in one atomic write, in which case the first pattern is appropriate.  E.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">begin_transmission</span><span class="p">(</span><span class="nv">I2C</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">qwrite_bytes</span><span class="p">(</span><span class="nv">I2C</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceAddress</span><span class="p">,</span><span class="w"> </span><span class="nv">Register1</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;some sequence of bytes&quot;</span><span class="o">&gt;&gt;</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">qwrite_bytes</span><span class="p">(</span><span class="nv">I2C</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceAddress</span><span class="p">,</span><span class="w"> </span><span class="nv">Register2</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;some other of bytes&quot;</span><span class="o">&gt;&gt;</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">end_transmission</span><span class="p">(</span><span class="nv">I2C</span><span class="p">),</span>
</pre></div>
</div>
<p>In other cases, you may just need to write a byte or sequence of bytes in one operation to the device:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">write_bytes</span><span class="p">(</span><span class="nv">I2C</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceAddress</span><span class="p">,</span><span class="w"> </span><span class="nv">Register1</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;write it all in one go&quot;</span><span class="o">&gt;&gt;</span><span class="p">),</span>
</pre></div>
</div>
<p>Reading bytes is more straightforward.  Simply use <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#read-bytes-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:read_bytes/3,4</span></code></span></a>, specifying the port instance, device address, optionally a register, and the number of bytes to read:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">BinaryData</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">read_bytes</span><span class="p">(</span><span class="nv">I2C</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceAddress</span><span class="p">,</span><span class="w"> </span><span class="nv">Register</span><span class="p">,</span><span class="w"> </span><span class="nv">Len</span><span class="p">)</span>
</pre></div>
</div>
<p>To close the I2C driver and free any resources in use by it, use the <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#close-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:close/1</span></code></span></a> function, supplying a reference to the I2C driver instance created via <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#open-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c:open/1</span></code></span></a>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">i2c</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">I2C</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the I2C driver is closed, any calls to <a class="reference internal" href="apidocs/erlang/eavmlib/i2c.html#function-index"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">i2c</span></code> functions</span></a> using a reference to the I2C driver instance should return with the value <code class="docutils literal notranslate"><span class="pre">{error,</span> <span class="pre">noproc}</span></code>.</p>
</section>
<section id="spi">
<h3>SPI<a class="headerlink" href="#spi" title="Link to this heading"></a></h3>
<p>The <a class="reference internal" href="apidocs/erlang/eavmlib/spi.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">spi</span></code> module</span></a> encapsulates functionality associated with the 4-wire Serial Peripheral Interface (SPI) in leader mode.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Information about the ESP32 SPI leader mode interface can be found in the IDF SDK <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/spi_master.html">SPI Documentation</a>.</p>
</div>
<p>The AtomVM SPI implementation uses the AtomVM Port mechanism and must be initialized using the <a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#open-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spi:open/1</span></code></span></a> function.  The single parameter to this function is a properties list containing:</p>
<ul class="simple">
<li><p><a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#bus-config"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">bus_config</span></code></span></a> – a properties list containing entries for the SPI bus</p></li>
<li><p><a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#device-config"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">device_config</span></code></span></a> – an optional properties list containing entries for each device attached to the SPI Bus</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">bus_config</span></code> properties list contains the following entries:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">poci</span></code> (<code class="docutils literal notranslate"><span class="pre">miso</span></code>)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI peripheral-out, controller-in pin (MOSI)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pico</span></code> (<code class="docutils literal notranslate"><span class="pre">mosi</span></code>)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI peripheral-in, controller-out pin (MISO)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sclk</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI clock pin (SCLK)</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">device_config</span></code> entry is a properties list containing entries for each device attached to the SPI Bus.  Each entry in this list contains the user-selected name (as an atom) of the device, followed by configuration for the named device.</p>
<p>Each device configuration is a properties list containing the following entries:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clock_speed_hz</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI clock frequency (in hertz)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">mode</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0..3</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI mode, indicating clock polarity (<code class="docutils literal notranslate"><span class="pre">CPOL</span></code>) and clock phase (<code class="docutils literal notranslate"><span class="pre">CPHA</span></code>).  Consult the SPI specification and data sheet for your device, for more information about how to control the behavior of the SPI clock.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cs</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>yes</p></td>
<td><p>SPI chip select pin (CS)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">address_len_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0..64</span></code></p></td>
<td><p>yes</p></td>
<td><p>number of bits in the address field of a read/write operation (for example, 8, if the transaction address field is a single byte)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">command_len_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0..16</span></code></p></td>
<td><p>default: 0</p></td>
<td><p>number of bits in the command field of a read/write operation (for example, 8, if the transaction command field is a single byte)</p></td>
</tr>
</tbody>
</table>
<p>For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">SPIConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="n">bus_config</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="n">miso</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="n">mosi</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="n">sclk</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span>
<span class="w">    </span><span class="p">]},</span>
<span class="w">    </span><span class="p">{</span><span class="n">device_config</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="n">my_device_1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="n">clock_speed_hz</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">address_len_bits</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">}</span>
<span class="w">        </span><span class="p">]}</span>
<span class="w">        </span><span class="p">{</span><span class="n">my_device_2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="n">clock_speed_hz</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="n">address_len_bits</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">}</span>
<span class="w">        </span><span class="p">]}</span>
<span class="w">    </span><span class="p">]}</span>
<span class="p">],</span>
<span class="nv">SPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">SPIConfig</span><span class="p">),</span>
<span class="p">...</span>
</pre></div>
</div>
<p>In the above example, there are two SPI devices, one using pin 18 chip select (named <code class="docutils literal notranslate"><span class="pre">my_device_1</span></code>), and once using pin 15 chip select (named <code class="docutils literal notranslate"><span class="pre">my_device_2</span></code>).</p>
<p>Once the port is opened, you can use the returned <code class="docutils literal notranslate"><span class="pre">SPI</span></code> instance, along with the selected device name, to read and write bytes to the attached device.</p>
<p>To read a byte at a given address on the device, use the <a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#read-at-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spi:read_at/4</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Byte</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">read_at</span><span class="p">(</span><span class="nv">SPI</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceName</span><span class="p">,</span><span class="w"> </span><span class="nv">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<p>To write a byte at a given address on the device, use the <a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#write-at-5"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spi_write_at/5</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">write_at</span><span class="p">(</span><span class="nv">SPI</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceName</span><span class="p">,</span><span class="w"> </span><span class="nv">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nv">Byte</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spi:write_at/5</span></code> takes integer values as inputs and the <code class="docutils literal notranslate"><span class="pre">spi:read_at/4</span></code> returns integer values. You may read and
write up to 32-bit integer values via these functions.</p>
</div>
<p>Consult your local device data sheet for information about various device addresses to read from or write to, and their semantics.</p>
<p>The above functions are optimized for small reads and writes to an SPI device, typically one byte at a time.</p>
<p>The SPI interface also supports a more generic way to read and write from an SPI device, supporting arbitrary-length reads and writes, as well as a number of different “phases” of writes, per the SPI specification.</p>
<p>These phases include:</p>
<ul class="simple">
<li><p>Command phase – write of an up-to 16-bit command to the SPI device</p></li>
<li><p>Address Phase – write of an up-to 64-bit address to the SPI device</p></li>
<li><p>Data Phase – read or write of an arbitrary amount of of data to and from the device.</p></li>
</ul>
<p>Any one of these phases may be included or omitted in any given SPI transaction.</p>
<p>In order to achieve this level of flexibility, these functions allow users to specify the SPI transaction through a map structure, which includes fields that specify the behavior of an SPI transaction.</p>
<p>The following table enumerates the permissible fields in this structure:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">command</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code> (16-bit)</p></td>
<td><p>(Optional) SPI command.  The low-order <code class="docutils literal notranslate"><span class="pre">command_len_bits</span></code> are written to the device.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">address</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code> (64-bit)</p></td>
<td><p>(Optional) Device address.  The low-order <code class="docutils literal notranslate"><span class="pre">address_len_bits</span></code> are written to the device.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">write_data</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">binary()</span></code></p></td>
<td><p>(Optional) Data to write</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">write_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Number of bits to write from `write_data’.  If not included,then all bits will be written.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">read_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Number of bits to read from the SPI device.  If not included, then the same number of bits will be read as were written.</p></td>
</tr>
</tbody>
</table>
<p>To write a blob of data to the SPI device, for example, you would use:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">WriteData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;some binary data&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">SPI</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceName</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">write_data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">WriteData</span><span class="p">})</span>
</pre></div>
</div>
<p>To write and simultaneously read back a blob of data to the SPI device, you would use:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">ReadData</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">write_read</span><span class="p">(</span><span class="nv">SPI</span><span class="p">,</span><span class="w"> </span><span class="nv">DeviceName</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">write_data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">WriteData</span><span class="p">})</span>
</pre></div>
</div>
<p>The size of the returned data is the same as the size of the written data, unless otherwise specified by the <code class="docutils literal notranslate"><span class="pre">read_bits</span></code> field.</p>
<p>Use the <a class="reference internal" href="apidocs/erlang/eavmlib/spi.html#close-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">spi:close/1</span></code></span></a> function to close the SPI driver and free any resources in use by it, supplying a reference to a previously opened SPI driver instance.  Any references to the closed SPI instance are no longer valid after a successful call to this function.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">spi</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">SPI</span><span class="p">).</span>
</pre></div>
</div>
</section>
<section id="uart">
<h3>UART<a class="headerlink" href="#uart" title="Link to this heading"></a></h3>
<p>The <a class="reference internal" href="apidocs/erlang/eavmlib/uart.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">uart</span></code> module</span></a> encapsulates functionality associated with the Universal Asynchronous Receiver/Transmitter (UART) interface supported on ESP32 devices.  Some devices, such as NMEA GPS receivers, make use of this interface for communicating with an ESP32.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Information about the ESP32 UART interface can be found in the IDF SDK <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/uart.html">UART Documentation</a>.</p>
</div>
<p>The AtomVM UART implementation uses the AtomVM Port mechanism and must be initialized using the <a class="reference internal" href="apidocs/erlang/eavmlib/uart.html#open-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">uart:open/2</span></code></span></a> function.</p>
<p>The first parameter indicates the ESP32 UART hardware interface.  Valid values are:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;UART0&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="s">&quot;UART1&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="s">&quot;UART2&quot;</span>
</pre></div>
</div>
<p>The second parameter is a properties list, containing the following elements:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rx</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>no</p></td>
<td><p>-1 (<code class="docutils literal notranslate"><span class="pre">UART_PIN_NO_CHANGE</span></code>)</p></td>
<td><p>RX GPIO Pin</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tx</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>no</p></td>
<td><p>-1 (<code class="docutils literal notranslate"><span class="pre">UART_PIN_NO_CHANGE</span></code>)</p></td>
<td><p>TX GPIO Pin</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">speed</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">integer()</span></code></p></td>
<td><p>no</p></td>
<td><p>115200</p></td>
<td><p>UART baud rate (bits/sec)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">data_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span> <span class="pre">|</span> <span class="pre">6</span> <span class="pre">|</span> <span class="pre">7</span> <span class="pre">|</span> <span class="pre">8</span></code></p></td>
<td><p>no</p></td>
<td><p>8</p></td>
<td><p>UART data bits</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">stop_bits</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">|</span> <span class="pre">2</span></code></p></td>
<td><p>no</p></td>
<td><p>1</p></td>
<td><p>UART stop bits</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">flow_control</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hardware</span> <span class="pre">|</span> <span class="pre">software</span> <span class="pre">|</span> <span class="pre">none</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">none</span></code></p></td>
<td><p>Flow control</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">parity</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">even</span> <span class="pre">|</span> <span class="pre">odd</span> <span class="pre">|</span> <span class="pre">none</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">none</span></code></p></td>
<td><p>UART parity check</p></td>
</tr>
</tbody>
</table>
<p>These are the usual RX and TX pins for the various UARTs on the ESP32 (as always check your board specs):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Port</p></th>
<th class="head"><p>RX pin</p></th>
<th class="head"><p>TX pin</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">UART0</span></code></p></td>
<td><p>GPIO_3</p></td>
<td><p>GPIO_1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">UART1</span></code></p></td>
<td><p>GPIO_9</p></td>
<td><p>GPIO_10</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">UART2</span></code></p></td>
<td><p>GPIO_16</p></td>
<td><p>GPIO_17</p></td>
</tr>
</tbody>
</table>
<p>For example,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">UART</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">uart</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="s">&quot;UART0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">speed</span><span class="p">,</span><span class="w"> </span><span class="mi">9600</span><span class="p">}])</span>
</pre></div>
</div>
<p>Once the port is opened, you can use the returned <code class="docutils literal notranslate"><span class="pre">UART</span></code> instance to read and write bytes to the attached device.</p>
<p>To read data from the UART channel, use the <a class="reference internal" href="apidocs/erlang/eavmlib/uart.html#read-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">uart:read/1</span></code></span></a> function.  The return value from this function is a binary:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">uart</span><span class="p">:</span><span class="nf">read</span><span class="p">(</span><span class="nv">UART</span><span class="p">)</span>
</pre></div>
</div>
<p>To write data to the UART channel, use the <a class="reference internal" href="apidocs/erlang/eavmlib/uart.html#write-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">uart_write/2</span></code></span></a> function.  The input data is any Erlang I/O list:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nn">uart</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">UART</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;any&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="sc">$d</span><span class="p">,</span><span class="w"> </span><span class="sc">$a</span><span class="p">,</span><span class="w"> </span><span class="sc">$t</span><span class="p">,</span><span class="w"> </span><span class="sc">$a</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;goes&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;here&quot;</span><span class="o">&gt;&gt;</span><span class="p">])</span>
</pre></div>
</div>
<p>Consult your local device data sheet for information about the format of data to be read from or written to the UART channel.</p>
<p>To close the UART driver and free any resources in use by it, use the <a class="reference internal" href="apidocs/erlang/eavmlib/uart.html#close-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">uart:close/1</span></code></span></a> function, supplying a reference to the UART driver instance created via <code class="docutils literal notranslate"><span class="pre">uart:open/2</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">uart</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">UART</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the UART driver is closed, any calls to <code class="docutils literal notranslate"><span class="pre">uart</span></code> functions using a reference to the UART driver instance should return with the value <code class="docutils literal notranslate"><span class="pre">{error,</span> <span class="pre">noproc}</span></code>.</p>
</section>
<section id="led-control">
<h3>LED Control<a class="headerlink" href="#led-control" title="Link to this heading"></a></h3>
<p>The LED Control API can be used to drive LEDs, as well as generate PWM signals on GPIO pins.</p>
<p>The LEDC API is encapsulated in the <a class="reference internal" href="apidocs/erlang/eavmlib/ledc.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">ledc</span></code> module</span></a> and is a direct translation of the IDF SDK <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/ledc.html">LEDC API</a>, with a natural mapping into Erlang.  This API is intended for users with complex use-cases, and who require low-level access to the LEDC APIs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ledc.hrl</span></code> module should be used for common modes, channels, duty cycle resolutions, and so forth.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;ledc.hrl&quot;</span><span class="p">).</span>

<span class="c">%% create a 5khz timer</span>
<span class="nv">SpeedMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span>
<span class="nv">Channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_CHANNEL_0</span><span class="p">,</span>
<span class="nn">ledc</span><span class="p">:</span><span class="nf">timer_config</span><span class="p">([</span>
<span class="w">    </span><span class="p">{</span><span class="n">duty_resolution</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_TIMER_13_BIT</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">freq_hz</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">speed_mode</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_HIGH_SPEED_MODE</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">timer_num</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_TIMER_0</span><span class="p">}</span>
<span class="p">]).</span>

<span class="c">%% bind pin 2 to this timer in a channel</span>
<span class="nn">ledc</span><span class="p">:</span><span class="nf">channel_config</span><span class="p">([</span>
<span class="w">    </span><span class="p">{</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="nv">Channel</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">duty</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">gpio_num</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">speed_mode</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_HIGH_SPEED_MODE</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">hpoint</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">timer_sel</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="nv">LEDC_TIMER_0</span><span class="p">}</span>
<span class="p">]).</span>

<span class="c">%% set the duty cycle to 0, and fade up to 16000 over 5 seconds</span>
<span class="nn">ledc</span><span class="p">:</span><span class="nf">set_duty</span><span class="p">(</span><span class="nv">SpeedMode</span><span class="p">,</span><span class="w"> </span><span class="nv">Channel</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span>
<span class="nn">ledc</span><span class="p">:</span><span class="nf">update_duty</span><span class="p">(</span><span class="nv">SpeedMode</span><span class="p">,</span><span class="w"> </span><span class="nv">Channel</span><span class="p">).</span>
<span class="nv">TargetDuty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16000</span><span class="p">.</span>
<span class="nv">FadeMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">.</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">ledc</span><span class="p">:</span><span class="nf">set_fade_with_time</span><span class="p">(</span><span class="nv">SpeedMode</span><span class="p">,</span><span class="w"> </span><span class="nv">Channel</span><span class="p">,</span><span class="w"> </span><span class="nv">TargetDuty</span><span class="p">,</span><span class="w"> </span><span class="nv">FadeMs</span><span class="p">).</span>
</pre></div>
</div>
</section>
</section>
<section id="protocols">
<h2>Protocols<a class="headerlink" href="#protocols" title="Link to this heading"></a></h2>
<p>AtomVM supports network programming on devices that support it, specifically the ESP32 platform, with its built-in support for WIFI networking, and of course on the UNIX platform.</p>
<p>This section describes the network programming APIs available on AtomVM.</p>
<section id="network-esp32-only">
<h3>Network (ESP32 only)<a class="headerlink" href="#network-esp32-only" title="Link to this heading"></a></h3>
<p>The ESP32 supports WiFi connectivity as part of the built-in WiFi and Bluetooth radio (and in most modules, an integrated antenna).  The WIFI radio on an ESP32 can operate in several modes:</p>
<ul class="simple">
<li><p>STA (Station) mode, whereby it acts as a member of an existing WiFi network;</p></li>
<li><p>AP (Access Point) mode, whereby the ESP32 acts as an access point for other devices; or</p></li>
<li><p>AP+STA mode, whereby the ESP32 behaves both as a member of an existing WiFi network and as an access point for other devices.</p></li>
</ul>
<p>AtomVM supports these modes of operation via the <a class="reference internal" href="apidocs/erlang/eavmlib/network.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">network</span></code> module</span></a>, which is used to initialize the network and allow applications to respond to events within the network, such as a network disconnect or reconnect, or a connection to the ESP32 from another device.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Establishment and maintenance of network connections on roaming devices is a complex and subtle art, and the AtomVM
<code class="docutils literal notranslate"><span class="pre">network</span></code> module is designed to accommodate as many IoT scenarios as possible.  This section of the programmer’s guide
is deliberately brief and only addresses the most basic scenarios.  For a more detailed explanation of the AtomVM
<code class="docutils literal notranslate"><span class="pre">network</span></code> module and its many use-cases, please refer to the <a class="reference internal" href="network-programming-guide.html"><span class="std std-doc">AtomVM Network Programming Guide</span></a>.</p>
</div>
<section id="sta-mode">
<h4>STA mode<a class="headerlink" href="#sta-mode" title="Link to this heading"></a></h4>
<p>To connect your ESP32 to an existing WiFi network, use the <a class="reference internal" href="apidocs/erlang/eavmlib/network.html#wait-for-sta-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">network:wait_for_sta/1,2</span></code></span></a> convenience function, which abstracts away some of the more complex details of ESP32 STA mode.</p>
<p>This function takes a station mode configuration, as a properties list, and optionally a timeout (in milliseconds) before connecting to the network should fail.  The default timeout, if unspecified, is 15 seconds.</p>
<p>The station mode configuration supports the following options:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ssid</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">binary()</span></code></p></td>
<td><p>yes</p></td>
<td><p>-</p></td>
<td><p>WiFi AP SSID</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">psk</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">binary()</span></code></p></td>
<td><p>yes, if network is encrypted</p></td>
<td><p>-</p></td>
<td><p>WiFi AP password</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dhcp_hostname</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">binary()</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">atomvm-&lt;MAC&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;MAC&gt;</span></code> is the factory-assigned MAC-address of the device</p></td>
<td><p>DHCP hostname for the connecting device</p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The WiFi network to which you are connecting must support DHCP and IPv4.
IPv6 addressing is not yet supported on AtomVM.</p>
</div>
<p>If the ESP32 device connects to the specified network successfully, the device’s assigned address, netmask, and gateway address will be returned in an <code class="docutils literal notranslate"><span class="pre">{ok,</span> <span class="pre">...}</span></code> tuple; otherwise, an error is returned.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;myssid&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">psk</span><span class="p">,</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="s">&quot;mypsk&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">dhcp_hostname</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;mydevice&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">],</span>
<span class="k">case</span><span class="w"> </span><span class="nn">network</span><span class="p">:</span><span class="nf">wait_for_sta</span><span class="p">(</span><span class="nv">Config</span><span class="p">,</span><span class="w"> </span><span class="mi">15000</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">Address</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Netmask</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Gateway</span><span class="p">}}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Acquired IP address: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Address</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Network initialization failed: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once connected to a WiFi network, you may begin TCP or UDP networking, as described in more detail below.</p>
<p>For information about how to handle disconnections and re-connections to a WiFi network, see the <a class="reference internal" href="network-programming-guide.html"><span class="std std-doc">AtomVM Network Programming Guide</span></a>.</p>
</section>
<section id="ap-mode">
<h4>AP mode<a class="headerlink" href="#ap-mode" title="Link to this heading"></a></h4>
<p>To turn your ESP32 into an access point for other devices, you can use the <a class="reference internal" href="apidocs/erlang/eavmlib/network.html#wait-for-ap-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">network:wait_for_ap/1,2</span></code></span></a> convenience function, which abstracts away some of the more complex details of ESP32 AP mode.  When the network is started, the ESP32 device will assign itself the <code class="docutils literal notranslate"><span class="pre">192.168.4.1</span></code> address.  Any devices that connect to the ESP32 will take addresses in the <code class="docutils literal notranslate"><span class="pre">192.168.4/24</span></code> network.</p>
<p>This function takes an access point mode configuration, as a properties list, and optionally a timeout (in milliseconds) before starting the network should fail.  The default timeout, if unspecified, is 15 seconds.</p>
<p>The access point mode configuration supports the following options:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ssid</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">binary()</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">atomvm-&lt;MAC&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;MAC&gt;</span></code> is the factory-assigned MAC-address of the device</p></td>
<td><p>WiFi AP SSID</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ssid_hidden</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">boolean()</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Whether the AP SSID should be hidden (i.e., not broadcast)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">psk</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">string()</span> <span class="pre">|</span> <span class="pre">binary()</span></code></p></td>
<td><p>yes, if network is encrypted</p></td>
<td><p>-</p></td>
<td><p>WiFi AP password.  Warning: If this option is not specified, the network will be an open network, to which anyone who knows the SSID can connect and which is not encrypted.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ap_max_connections</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>no</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p>Maximum number of devices that can be connected to this AP</p></td>
</tr>
</tbody>
</table>
<p>If the ESP32 device starts the AP network successfully, the <code class="docutils literal notranslate"><span class="pre">ok</span></code> atom is returned; otherwise, an error is returned.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="n">psk</span><span class="p">,</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="s">&quot;mypsk&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">],</span>
<span class="k">case</span><span class="w"> </span><span class="nn">network</span><span class="p">:</span><span class="nf">wait_for_ap</span><span class="p">(</span><span class="nv">Config</span><span class="p">,</span><span class="w"> </span><span class="mi">15000</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;AP network started at 192.168.4.1</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Network initialization failed: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once the WiFi network is started, you may begin TCP or UDP networking, as described in more detail below.</p>
<p>For information about how to handle connections and disconnections from attached devices, see the <a class="reference internal" href="network-programming-guide.html"><span class="std std-doc">AtomVM Network Programming Guide</span></a>.</p>
</section>
<section id="sta-ap-mode">
<h4>STA+AP mode<a class="headerlink" href="#sta-ap-mode" title="Link to this heading"></a></h4>
<p>For information about how to run the AtomVM network in STA and AP mode simultaneously, see the <a class="reference internal" href="network-programming-guide.html#sta-ap-mode"><span class="std std-ref">AtomVM Network Programming Guide</span></a>.</p>
</section>
<section id="sntp">
<h4>SNTP<a class="headerlink" href="#sntp" title="Link to this heading"></a></h4>
<p>For information about how to use SNTP to synchronize the clock on your device, see the <a class="reference internal" href="network-programming-guide.html#sntp-support"><span class="std std-ref">AtomVM Network Programming Guide</span></a>.</p>
</section>
</section>
<section id="udp">
<h3>UDP<a class="headerlink" href="#udp" title="Link to this heading"></a></h3>
<p>AtomVM supports network programming using the User Datagram Protocol (UDP) via the <a class="reference internal" href="apidocs/erlang/estdlib/gen_udp.html"><span class="doc std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_udp</span></code> module</span></a>.  This modules obeys the syntax and semantics of the Erlang/OTP <a class="reference external" href="https://erlang.org/doc/man/gen_udp.html"><code class="docutils literal notranslate"><span class="pre">gen_udp</span></code></a> interface.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Not all of the Erlang/OTP <code class="docutils literal notranslate"><span class="pre">gen_udp</span></code> functionality is implemented in AtomVM.  For details, consult the
<a class="reference internal" href="apidocs/erlang/estdlib/gen_udp.html"><span class="std std-doc">AtomVM API documentation</span></a>.</p>
</div>
<p>To open a UDP port, use the <a class="reference internal" href="apidocs/erlang/estdlib/gen_udp.html#open-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gen_udp:open/1,2</span></code></span></a> function.  Supply a port number, and if your application plans to receive UDP messages, specify that the port is active via the <code class="docutils literal notranslate"><span class="pre">{active,</span> <span class="pre">true}</span></code> property in the optional properties list.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44404</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="n">true</span><span class="p">},</span><span class="w"> </span><span class="n">binary</span><span class="p">])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">SockName</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">sockname</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Opened UDP socket on </span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">SockName</span><span class="p">])</span>
<span class="w">    </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred opening UDP socket: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If the port is active, you can receive UDP messages in your application.  They will be delivered as a 5-tuple, starting with the <code class="docutils literal notranslate"><span class="pre">udp</span></code> atom, and containing the socket, address and port from which the message was sent, as well as the datagram packet, itself, as a list (by default) or a binary. To choose the format, pass <code class="docutils literal notranslate"><span class="pre">list</span></code> or <code class="docutils literal notranslate"><span class="pre">binary</span></code> in options, as with Erlang/OTP.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">receive</span>
<span class="w">    </span><span class="p">{</span><span class="n">udp</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">Addr</span><span class="p">,</span><span class="w"> </span><span class="nv">Port</span><span class="p">,</span><span class="w"> </span><span class="nv">Packet</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Received UDP packet </span><span class="si">~p</span><span class="s"> from address </span><span class="si">~p</span><span class="s"> port </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Packet</span><span class="p">,</span><span class="w"> </span><span class="nv">Addr</span><span class="p">,</span><span class="w"> </span><span class="nv">Port</span><span class="p">])</span>
<span class="k">end</span><span class="p">,</span>
</pre></div>
</div>
<p>With a reference to a UDP <code class="docutils literal notranslate"><span class="pre">Socket</span></code>, you can send messages to a target UDP endpoint using the <a class="reference internal" href="apidocs/erlang/estdlib/gen_udp.html#send-4"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gen_udp:send/4</span></code></span></a> function.  Specify the UDP socket returned from <code class="docutils literal notranslate"><span class="pre">gen_udp:open/1,2</span></code>, the address (as a 4-tuple of octets), port number, and the datagram packet to send:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;:アトムＶＭ&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="nv">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">},</span>
<span class="nv">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44404</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">Address</span><span class="p">,</span><span class="w"> </span><span class="nv">Port</span><span class="p">,</span><span class="w"> </span><span class="nv">Packet</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Sent </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Packet</span><span class="p">]);</span>
<span class="w">    </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred sending a packet: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>IPv6 networking is not currently supported in AtomVM.</p>
</div>
</section>
<section id="tcp">
<h3>TCP<a class="headerlink" href="#tcp" title="Link to this heading"></a></h3>
<p>AtomVM supports network programming using the Transport Connection Protocol (TCP) via the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code> module</span></a>.  This modules obeys the syntax and semantics of the Erlang/OTP <a class="reference external" href="https://erlang.org/doc/man/gen_tcp.html"><code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code></a> interface.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Not all of the Erlang/OTP <code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code> functionality is implemented in AtomVM.  For details, consults the
<a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc">AtomVM API documentation</span></a>.</p>
</div>
<section id="server-side-tcp">
<h4>Server-side TCP<a class="headerlink" href="#server-side-tcp" title="Link to this heading"></a></h4>
<p>Server side TCP requires opening a listening socket, and then waiting to accept connections from remote clients.  Once a connection is established, the application may then use a combination of sending and receiving packets over the established connection to or from the remote client.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Programming TCP on the server-side using the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code></span></a> interface is a subtle
art, and this portion of the documentation will not go into all of the design choices available when designing a TCP
application.</p>
</div>
<p>Start by opening a listening socket using the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html#listen-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gen_tcp:listen/2</span></code></span></a> function.  Specify the port number on which the TCP server should be listening:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="mi">44405</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">ListenSocket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">SockName</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">sockname</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Listening for connections at address </span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">SockName</span><span class="p">]),</span>
<span class="w">        </span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span><span class="w"> </span><span class="k">end</span><span class="p">);</span>
<span class="w">    </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred listening: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>In this particular example, the server will spawn a new process to wait to accept a connection from a remote client, by calling the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html#accept-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gen_tcp:accept/1</span></code></span></a> function, passing in a reference to the listening socket.  This function will block until a client has established a connection with the server.</p>
<p>When a client connects, the function will return a tuple <code class="docutils literal notranslate"><span class="pre">{ok,</span> <span class="pre">Socket}</span></code>, where <code class="docutils literal notranslate"><span class="pre">Socket</span></code> is a reference to the connection between the client and server:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Waiting to accept connection...</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">SockName</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">sockname</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">            </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">peername</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">            </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Accepted connection.  local: </span><span class="si">~p</span><span class="s"> peer: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">SockName</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">]),</span>
<span class="w">            </span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span><span class="w"> </span><span class="k">end</span><span class="p">),</span>
<span class="w">            </span><span class="n">echo</span><span class="p">();</span>
<span class="w">        </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred accepting connection: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="w">    </span><span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that immediately after accepting a connection, this example code will spawn a new process to accept any new
connections from other clients.</p>
</div>
<p>The socket returned from <code class="docutils literal notranslate"><span class="pre">gen_tcp:accept/1</span></code> can then be used to send and receive messages to the connected client:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">echo</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Waiting to receive data...</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="k">receive</span>
<span class="w">        </span><span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Connection closed.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">ok</span><span class="p">;</span>
<span class="w">        </span><span class="p">{</span><span class="n">tcp</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">Packet</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">peername</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">            </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Received packet </span><span class="si">~p</span><span class="s"> from </span><span class="si">~p</span><span class="s">.  Echoing back...</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Packet</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">]),</span>
<span class="w">            </span><span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">Packet</span><span class="p">),</span>
<span class="w">            </span><span class="n">echo</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>In this case, the server program will continuously echo the received input back to the client, until the client closes the connection.</p>
<p>For more information about the <code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code> server interface, consult the AtomVM <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc">API Reference Documentation</span></a>.</p>
</section>
<section id="client-side-tcp">
<h4>Client-side TCP<a class="headerlink" href="#client-side-tcp" title="Link to this heading"></a></h4>
<p>Client side TCP requires establishing a connection with an endpoint, and then using a combination of sending and receiving packets over the established connection.</p>
<p>Start by opening a connection to another TCP endpoint using the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html#connect-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">gen_tcp:connect/3</span></code></span></a> function.  Supply the address and port of the TCP endpoint.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">},</span>
<span class="nv">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44405</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span><span class="w"> </span><span class="nv">Port</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">SockName</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">sockname</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">peername</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Connected to </span><span class="si">~p</span><span class="s"> from </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Peername</span><span class="p">,</span><span class="w"> </span><span class="nv">SockName</span><span class="p">]);</span>
<span class="w">    </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred connecting: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once a connection is established, you can use a combination of</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">SendPacket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s">&quot;:アトムＶＭ&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">SendPacket</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">receive</span>
<span class="w">            </span><span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Connection closed.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
<span class="w">                </span><span class="n">ok</span><span class="p">;</span>
<span class="w">            </span><span class="p">{</span><span class="n">tcp</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">ReceivedPacket</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">inet</span><span class="p">:</span><span class="nf">peername</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="w">                </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Received </span><span class="si">~p</span><span class="s"> from </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">ReceivedPacket</span><span class="p">,</span><span class="w"> </span><span class="nv">Peername</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span><span class="p">;</span>
<span class="w">    </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred sending a packet: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>For more information about the <code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code> client interface, consults the <a class="reference internal" href="apidocs/erlang/estdlib/gen_tcp.html"><span class="std std-doc">AtomVM API documentation</span></a>.</p>
</section>
</section>
</section>
<section id="socket-programming">
<h2>Socket Programming<a class="headerlink" href="#socket-programming" title="Link to this heading"></a></h2>
<p>AtomVM supports a subset of the OTP <a class="reference external" href="https://www.erlang.org/doc/man/socket.html"><code class="docutils literal notranslate"><span class="pre">socket</span></code></a> interface, giving users more fine-grained control in socket programming.</p>
<p>The OTP socket APIs are relatively new (they were introduced in OTP 22 and have seen revisions in OTP 24).  These APIs broadly mirror the <a class="reference external" href="https://en.wikipedia.org/wiki/Berkeley_sockets">BSD Sockets</a> API, and should be familiar to most programmers who have had to work with low-level operating system networking interfaces.  AtomVM <a class="reference internal" href="apidocs/erlang/estdlib/socket.html"><span class="std std-doc">supports a strict subset</span></a> of the OTP APIs.  Future versions of AtomVM may add additional coverage of these APIs.</p>
<p>The following types are relevant to this interface and are referenced in the remainder of this section:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">domain</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">inet</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">type</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">dgram</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">protocol</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">udp</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">socket</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">any</span><span class="p">().</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">sockaddr</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">sockaddr_in</span><span class="p">().</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">sockaddr_in</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">#{</span>
<span class="w">    </span><span class="n">family</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">port_number</span><span class="p">(),</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">loopback</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">in_addr</span><span class="p">()</span>
<span class="p">}.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">in_addr</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">..</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">255</span><span class="p">}.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">port_number</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="mi">0</span><span class="p">..</span><span class="mi">65535</span><span class="p">.</span>
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">socket_option</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">reuseaddr</span><span class="p">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">{</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">linger</span><span class="p">}.</span>
</pre></div>
</div>
<p>Create a socket using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#open-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:open/3</span></code></span></a> function, providing a domain, type, and protocol.  Currently, AtomVM supports the <code class="docutils literal notranslate"><span class="pre">inet</span></code> domain, <code class="docutils literal notranslate"><span class="pre">stream</span></code> and <code class="docutils literal notranslate"><span class="pre">dgram</span></code> types, and <code class="docutils literal notranslate"><span class="pre">tcp</span></code> and <code class="docutils literal notranslate"><span class="pre">udp</span></code> protocols.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">tcp</span><span class="p">),</span>
</pre></div>
</div>
<section id="server-side-tcp-socket-programming">
<h3>Server-side TCP Socket Programming<a class="headerlink" href="#server-side-tcp-socket-programming" title="Link to this heading"></a></h3>
<p>To program using sockets on the server side, you can bind an opened socket to an address and port number using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#bind-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:bind/2</span></code></span></a> function, supplying a map that specifies the address and port number.</p>
<p>This map may contain the following entries:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">family</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">inet</span></code></p></td>
<td><p></p></td>
<td><p>The address family.  (Currently, only <code class="docutils literal notranslate"><span class="pre">inet</span></code> is supported)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">addr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">in_addr()</span> <span class="pre">|</span> <span class="pre">any</span> <span class="pre">|</span> <span class="pre">loopback</span></code></p></td>
<td><p></p></td>
<td><p>The address to which to bind.  The <code class="docutils literal notranslate"><span class="pre">any</span></code> value will bind the socket to all interfaces on the device.  The <code class="docutils literal notranslate"><span class="pre">loopback</span></code> value will bind the socket to the loopback interface on the device.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">port</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">port_number()</span></code></p></td>
<td><p></p></td>
<td><p>The port to which to bind the socket.  If no port is specified, the operating system will choose a port for the user.</p></td>
</tr>
</tbody>
</table>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">PortNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8080</span><span class="p">,</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">bind</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">family</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">PortNumber</span><span class="p">}),</span>
</pre></div>
</div>
<p>To listen for connections, use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#listen-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:listen/1</span></code></span></a> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
</pre></div>
</div>
<p>Once your socket is listening on an interface and port, you can wait to accept a connection from an incoming client using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#accept-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:accept/1</span></code></span></a> function.</p>
<p>This function will block the current execution context (i.e., Erlang process) until a client establishes a TCP connection with the server:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">ConnectedSocket</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Many applications will spawn processes to listen for socket connections, so that the main execution context of your
application is not blocked.</p>
</div>
</section>
<section id="client-side-tcp-socket-programming">
<h3>Client-side TCP Socket Programming<a class="headerlink" href="#client-side-tcp-socket-programming" title="Link to this heading"></a></h3>
<p>To program using sockets on the client side, you can connect an opened socket to an address and port number using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#connect-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:connect/2</span></code></span></a> function, supplying a map that specifies the address and port number.</p>
<p>This map may contain the following entries:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">family</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">inet</span></code></p></td>
<td><p></p></td>
<td><p>The address family.  (Currently, only <code class="docutils literal notranslate"><span class="pre">inet</span></code> is supported)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">addr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">in_addr()</span></code> | <code class="docutils literal notranslate"><span class="pre">loopback</span></code></p></td>
<td><p></p></td>
<td><p>The address to which to connect. The <code class="docutils literal notranslate"><span class="pre">loopback</span></code> value will connect the socket to the loopback interface on the device.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">port</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">port_num()</span></code></p></td>
<td><p></p></td>
<td><p>The port to which to connect the socket.</p></td>
</tr>
</tbody>
</table>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">family</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">loopback</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">44404</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="sending-and-receiving-data">
<h3>Sending and Receiving Data<a class="headerlink" href="#sending-and-receiving-data" title="Link to this heading"></a></h3>
<p>Once you have a connected socket (either via <code class="docutils literal notranslate"><span class="pre">socket:connect/2</span></code> or <code class="docutils literal notranslate"><span class="pre">socket:accept/1</span></code>), you can send and receive data on that socket using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#send-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:send/2</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#recv-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:recv/1</span></code></span></a> functions.  Like the  <code class="docutils literal notranslate"><span class="pre">socket:accept/1</span></code> function, these functions will block until data is sent to a connected peer (or until the data is written to operating system buffers) or received from a connected peer.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">socket:send/2</span></code> function can take a binary blob of data or an io-list, containing binary data.</p>
<p>For example, a process that receives data and echos it back to the connected peer might be implemented as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">ConnectedSocket</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Data</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">ConnectedSocket</span><span class="p">,</span><span class="w"> </span><span class="nv">Data</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">            </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;All data was sent</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Rest</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Some data was sent.  Remaining: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Rest</span><span class="p">]);</span>
<span class="w">            </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred sending data: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span><span class="p">;</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">closed</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Connection closed.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred waiting on a connected socket: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">socket:recv/1</span></code> function will block the current process until a packet has arrived or until the local or remote socket has been closed, or some other error occurs.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">socket:send/2</span></code> function may return <code class="docutils literal notranslate"><span class="pre">ok</span></code> if all of the data has been sent, or <code class="docutils literal notranslate"><span class="pre">{ok,</span> <span class="pre">Rest}</span></code>, where <code class="docutils literal notranslate"><span class="pre">Rest</span></code> is the remaining part of the data that was not sent to the operating system.  If the supplied input to <code class="docutils literal notranslate"><span class="pre">socket:send/2</span></code> is an io-list, then the <code class="docutils literal notranslate"><span class="pre">Rest</span></code> will be a binary containing the rest of the data in the io-list.</p>
</section>
<section id="getting-information-about-connected-sockets">
<h3>Getting Information about Connected Sockets<a class="headerlink" href="#getting-information-about-connected-sockets" title="Link to this heading"></a></h3>
<p>You can obtain information about connected sockets using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#sockname-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:sockname/1</span></code></span></a> and <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#peername-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:peername/1</span></code></span></a> functions.  Supply the connected socket as a parameter.  The address and port are returned in a map structure</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">addr</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">LocalAddress</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">LocalPort</span><span class="p">}}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">sockname</span><span class="p">(</span><span class="nv">ConnectedSocket</span><span class="p">),</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">addr</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">PeerAddress</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">PeerPort</span><span class="p">}}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">peername</span><span class="p">(</span><span class="nv">ConnectedSocket</span><span class="p">),</span>
</pre></div>
</div>
</section>
<section id="closing-and-shutting-down-sockets">
<h3>Closing and Shutting down Sockets<a class="headerlink" href="#closing-and-shutting-down-sockets" title="Link to this heading"></a></h3>
<p>Use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#close-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:close/1</span></code></span></a> function to close a connected socket:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">ConnectedSocket</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Data that has been buffered by the operating system may not be delivered, when a socket is closed via the <code class="docutils literal notranslate"><span class="pre">close/1</span></code>
operation.</p>
</div>
<p>For a more controlled way to close full-duplex connected sockets, use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#shutdown-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:shutdown/2</span></code></span></a> function.  Provide the atom <code class="docutils literal notranslate"><span class="pre">read</span></code> if you only want to shut down the reads on the socket, <code class="docutils literal notranslate"><span class="pre">write</span></code> if you want to shut down writes on the socket, or <code class="docutils literal notranslate"><span class="pre">read_write</span></code> to shut down both reads and writes on a socket.  Subsequent reads or writes on the socket will result in an <code class="docutils literal notranslate"><span class="pre">einval</span></code> error on the calls, depending on how the socket has been shut down.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">shutdown</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="n">read_write</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="setting-socket-options">
<h3>Setting Socket Options<a class="headerlink" href="#setting-socket-options" title="Link to this heading"></a></h3>
<p>You can set options on a socket using the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#setopt-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:setopt/3</span></code></span></a> function.  This function takes an opened socket, a key, and a value, and returns <code class="docutils literal notranslate"><span class="pre">ok</span></code> if setting the option succeeded.</p>
<p>Currently, the following options are supported:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Option Key</p></th>
<th class="head"><p>Option Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">{socket,</span> <span class="pre">reuseaddr}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">boolean()</span></code></p></td>
<td><p>Sets <code class="docutils literal notranslate"><span class="pre">SO_REUSEADDR</span></code> on the socket.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">{socket,</span> <span class="pre">linger}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">#{onoff</span> <span class="pre">=&gt;</span> <span class="pre">boolean(),</span> <span class="pre">linger</span> <span class="pre">=&gt;</span> <span class="pre">non_neg_integer()}</span></code></p></td>
<td><p>Sets <code class="docutils literal notranslate"><span class="pre">SO_LINGER</span></code> on the socket.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">{otp,</span> <span class="pre">rcvbuf}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">non_neg_integer()</span></code></p></td>
<td><p>Sets the default buffer size (in bytes) on receive calls.  This value is only used if the <code class="docutils literal notranslate"><span class="pre">Length</span></code> parameter of the <code class="docutils literal notranslate"><span class="pre">socket:recv</span></code> family of functions has the value <code class="docutils literal notranslate"><span class="pre">0</span></code>; otherwise, the specified non-zero length in the <code class="docutils literal notranslate"><span class="pre">socket:recv</span></code> takes precedence.  Note that the OTP option value <code class="docutils literal notranslate"><span class="pre">default</span></code> is not currently supported.</p></td>
</tr>
</tbody>
</table>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">setopt</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">reuseaddr</span><span class="p">},</span><span class="w"> </span><span class="n">true</span><span class="p">),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">setopt</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">linger</span><span class="p">},</span><span class="w"> </span><span class="p">#{</span><span class="n">onoff</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">true</span><span class="p">,</span><span class="w"> </span><span class="n">linger</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">}),</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">setopt</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">otp</span><span class="p">,</span><span class="w"> </span><span class="n">rcvbuf</span><span class="p">},</span><span class="w"> </span><span class="mi">1024</span><span class="p">),</span>
</pre></div>
</div>
</section>
<section id="udp-socket-programming">
<h3>UDP Socket Programming<a class="headerlink" href="#udp-socket-programming" title="Link to this heading"></a></h3>
<p>You can use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">socket</span></code> interface</span></a> to send and receive messages over the User Datagram Protocol (UDP), in addition to TCP.</p>
<p>To use UDP sockets, open a socket using the <code class="docutils literal notranslate"><span class="pre">dgram</span></code> type and <code class="docutils literal notranslate"><span class="pre">udp</span></code> protocol.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Socket</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">dgram</span><span class="p">,</span><span class="w"> </span><span class="n">udp</span><span class="p">)</span>
</pre></div>
</div>
<p>To listen for UDP connections, use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#bind-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:bind/2</span></code></span></a> function, as described above.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">PortNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span>
<span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">bind</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="p">#{</span><span class="n">family</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">PortNumber</span><span class="p">}),</span>
</pre></div>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#recvfrom-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:recvfrom/1</span></code></span></a> function to receive UDP packets from clients on your network.  When a packet arrives, this function will return the received packet, as well as the address of the client that sent the packet.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">recvfrom</span><span class="p">(</span><span class="n">dSocket</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">From</span><span class="p">,</span><span class="w"> </span><span class="nv">Packet</span><span class="p">}}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Received packet </span><span class="si">~p</span><span class="s"> from </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Packet</span><span class="p">,</span><span class="w"> </span><span class="nv">From</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Error on recvfrom: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code class="docutils literal notranslate"><span class="pre">socket:recvfrom/1</span></code> function will block the current process until a packet has arrived or until the local or
remote socket has been closed, or some other error occurs.</p>
</div>
<p>Use the <a class="reference internal" href="apidocs/erlang/estdlib/socket.html#sendto-3"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">socket:sendto/3</span></code></span></a> function to send UDP packets to a specific destination.  Specify the socket, data, and destination address you would like the packet to be delivered to.</p>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nv">Dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">#{</span><span class="n">family</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">loopback</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">512</span><span class="p">},</span>
<span class="k">case</span><span class="w"> </span><span class="nn">socket</span><span class="p">:</span><span class="nf">sendto</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="w"> </span><span class="nv">Data</span><span class="p">,</span><span class="w"> </span><span class="nv">Dest</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Send packet </span><span class="si">~p</span><span class="s"> to </span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Data</span><span class="p">,</span><span class="w"> </span><span class="nv">Dest</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Rest</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Send packet </span><span class="si">~p</span><span class="s"> to </span><span class="si">~p</span><span class="s">.  Remaining: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Data</span><span class="p">,</span><span class="w"> </span><span class="nv">Dest</span><span class="p">,</span><span class="w"> </span><span class="nv">Rest</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nv">Reason</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;An error occurred sending a packet: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Reason</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Close a UDP socket just as you would a TCP socket, as described above.</p>
</section>
<section id="miscellaneous-networking-apis">
<h3>Miscellaneous Networking APIs<a class="headerlink" href="#miscellaneous-networking-apis" title="Link to this heading"></a></h3>
<p>You can retrieve information about hostnames and services using the <a class="reference internal" href="apidocs/erlang/estdlib/net.html#getaddrinfo-1"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">net:getaddrinfo/1</span></code></span></a> and  <a class="reference internal" href="apidocs/erlang/estdlib/net.html#getaddrinfo-2"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">net:getaddrinfo/2</span></code></span></a> functions.  The return value is a list of maps each of which contains address information about the host, including its family (<code class="docutils literal notranslate"><span class="pre">inet</span></code>), protocol (<code class="docutils literal notranslate"><span class="pre">tcp</span></code> or <code class="docutils literal notranslate"><span class="pre">udp</span></code>), type (<code class="docutils literal notranslate"><span class="pre">stream</span></code> or <code class="docutils literal notranslate"><span class="pre">dgram</span></code>), and the address, currently an IPv4 tuple.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Currently, the <code class="docutils literal notranslate"><span class="pre">net:getaddrinfo/1,2</span></code> functions only supports reporting of IPv4 addresses.</p>
</div>
<p>For example:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">AddrInfos</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">net</span><span class="p">:</span><span class="nf">getaddrinfo</span><span class="p">(</span><span class="s">&quot;atomvm.org&quot;</span><span class="p">),</span>

<span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span>
<span class="w">    </span><span class="k">fun</span><span class="p">(</span><span class="nv">AddrInfo</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="p">#{</span>
<span class="w">            </span><span class="n">family</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">Family</span><span class="p">,</span>
<span class="w">            </span><span class="n">protocol</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">Protocol</span><span class="p">,</span>
<span class="w">            </span><span class="n">type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">Type</span><span class="p">,</span>
<span class="w">            </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nv">Address</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">AddrInfo</span><span class="p">,</span>

<span class="w">        </span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;family: </span><span class="si">~p</span><span class="s"> protocol: </span><span class="si">~p</span><span class="s"> type: </span><span class="si">~p</span><span class="s"> address: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">Family</span><span class="p">,</span><span class="w"> </span><span class="nv">Protocol</span><span class="p">,</span><span class="w"> </span><span class="nv">Type</span><span class="p">,</span><span class="w"> </span><span class="nv">Address</span><span class="p">]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="k">end</span><span class="p">,</span>
<span class="w">    </span><span class="nv">AddrInfos</span>
<span class="p">),</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">host</span></code> parameter can be a domain name (typically) or a dotted pair IPv4 address.</p>
<p>The returned map contains the network family (currently, only <code class="docutils literal notranslate"><span class="pre">inet</span></code> is supported), the protocol, type, and address of the host.</p>
<p>The address is itself a map, containing the family, port and IPv4 address of the requested host, e.g.,</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">#{</span><span class="n">family</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">inet</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w"> </span><span class="mi">153</span><span class="p">}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://www.erlang.org/doc/man/net#type-address_info">OTP documentation</a> states that the address is returned
under the <code class="docutils literal notranslate"><span class="pre">address</span></code> key in the address info map.  However, OTP appears to use <code class="docutils literal notranslate"><span class="pre">addr</span></code> as the key.  For compatibility
with OTP 22 ff., AtomVM supports both the <code class="docutils literal notranslate"><span class="pre">address</span></code> and <code class="docutils literal notranslate"><span class="pre">addr</span></code> keys in this map (they reference the same inner map).</p>
</div>
<p>If you want to narrow the information you get back to a specific service type, you can specify a service name or port number (as a string value) as the second parameter:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">AddrInfos</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">net</span><span class="p">:</span><span class="nf">getaddrinfo</span><span class="p">(</span><span class="s">&quot;atomvm.org&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;https&quot;</span><span class="p">),</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Service names are well-known identifiers on the internet, but they may vary from operating system to operating system.  See the <code class="docutils literal notranslate"><span class="pre">services(3)</span></code> man pages for more information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Narrowing results via the service parameter is not supported on all platforms.  In the case where it is not
supported, AtomVM will resort to retrying the request without the service parameter.</p>
</div>
</section>
</section>
<section id="where-to-go-from-here">
<h2>Where to go from here<a class="headerlink" href="#where-to-go-from-here" title="Link to this heading"></a></h2>
<p>For more examples of how to use the AtomVM APIs check out the AtomVM <a class="reference external" href="https://github.com/atomvm/atomvm_examples">Example Programs</a>.</p>
<p>If you have not already, you may want to read the chapter on <a class="reference internal" href="atomvm-tooling.html"><span class="std std-doc">AtomVM Tooling</span></a> to help you get your applications built and flashed to a microcontroller.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="atomvm-tooling.html" class="btn btn-neutral float-left" title="AtomVM Tooling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="network-programming-guide.html" class="btn btn-neutral float-right" title="Network Programming Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AtomVM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <!--
 Copyright 2023 Winford (Uncle Grumpy) <winford@object.stream>

 SPDX-License-Identifier: Apache-2.0 OR LGPL-2.1-or-later

 Based on the work of  Michael Altfield:
 https://tech.michaelaltfield.net/2020/07/18/sphinx-rtd-github-pages-1
-->



  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-download"></span><span class="fa fa-book"> AtomVM Docs version:</span>
      release-0.6 branch (unreleased)
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt><span class="fa fa-book"> Versions</span></dt>
        
          
          <dd><a href="/v0.5.0/">v0.5.0</a></dd>
          
        
          
          <dd><a href="/v0.6.0/">v0.6.0</a></dd>
          
        
          
          <dd><a href="/v0.6.1/">v0.6.1</a></dd>
          
        
          
          <dd><a href="/v0.6.2/">v0.6.2</a></dd>
          
        
          
          <dd><a href="/v0.6.3/">v0.6.3</a></dd>
          
        
          
          <dd><a href="/v0.6.4/">v0.6.4</a></dd>
          
        
          
          <dd><a href="/v0.6.5/">v0.6.5</a></dd>
          
        
          
          <dd><a href="/v0.6.6/">v0.6.6</a></dd>
          
        
          
          <dd><a href="/main/">main branch (unstable)</a></dd>
          
        
           <strong> 
          <dd><a href="/release-0.6/">release-0.6 branch (unreleased)</a></dd>
           </strong> 
        
      </dl>
      
      
      <dl>
        <dt><span class="fa fa-download"> Downloads</span></dt>
        
          <dd><a href="/release-0.6/pdf/AtomVM-release-0.6.pdf">pdf</a></dd>
        
          <dd><a href="/release-0.6/epub/AtomVM-release-0.6.epub">epub</a></dd>
        
      </dl>
      
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>